{# Macro for package table rows #}
{% macro package_row(pkg) %}
<tr class="{% if not pkg.active %}table-secondary{% endif %}">
    <td>
        <strong>{{ pkg.package_name }}</strong>
        {% if pkg.package_description %}
        <br><small class="text-muted">{{ pkg.package_description[:60] }}{% if pkg.package_description|length > 60 %}...{% endif %}</small>
        {% endif %}
    </td>
    <td class="text-end">
        <strong>{{ "%.2f"|format(pkg.base_price) }} €</strong>
        {% if pkg.price_type == 'per_person' %}
        <small class="text-muted">/pers</small>
        {% endif %}
    </td>
    <td class="text-center">
        {{ pkg.min_people }}-{{ pkg.max_people }}
        <small class="text-muted">({{ pkg.standard_people }})</small>
    </td>
    <td class="text-center">
        <small class="text-muted">{{ pkg.zone_name or 'Todas' }}</small>
    </td>
    <td class="text-center">
        {% if pkg.active %}
        <span class="badge bg-success">Activo</span>
        {% else %}
        <span class="badge bg-secondary">Inactivo</span>
        {% endif %}
    </td>
    <td class="text-center">
        <a href="{{ url_for('beach.beach_config.packages_edit', package_id=pkg.id) }}"
           class="btn btn-sm btn-outline-primary" title="Editar">
            <i class="fa-solid fa-edit"></i>
        </a>
        <form method="POST" action="{{ url_for('beach.beach_config.packages_delete', package_id=pkg.id) }}"
              class="d-inline" onsubmit="return confirm('¿Eliminar paquete {{ pkg.package_name }}?')">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-sm btn-outline-danger" title="Eliminar">
                <i class="fa-solid fa-trash"></i>
            </button>
        </form>
    </td>
</tr>
{% endmacro %}

{# Macro for package section #}
{% macro package_section(title, icon, badge_class, packages_list, customer_type_param, show_inactive) %}
<div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
            <i class="{{ icon }} me-2"></i>{{ title }}
            <span class="badge {{ badge_class }} ms-2">{{ packages_list|length }}</span>
        </h6>
        <a href="{{ url_for('beach.beach_config.packages_create', customer_type=customer_type_param) }}"
           class="btn btn-sm btn-outline-primary">
            <i class="fa-solid fa-plus"></i> Añadir
        </a>
    </div>
    {% if packages_list %}
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th class="text-end" style="width: 120px;">Precio</th>
                        <th class="text-center" style="width: 100px;">Personas</th>
                        <th class="text-center" style="width: 100px;">Zona</th>
                        <th class="text-center" style="width: 80px;">Estado</th>
                        <th class="text-center" style="width: 100px;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pkg in packages_list %}
                    {{ package_row(pkg) }}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="card-body text-center py-4">
        <p class="text-muted mb-0 small">Sin paquetes configurados</p>
    </div>
    {% endif %}
</div>
{% endmacro %}

{# Group packages by customer type #}
{% set interno_packages = packages|selectattr('customer_type', 'equalto', 'interno')|list %}
{% set externo_packages = packages|selectattr('customer_type', 'equalto', 'externo')|list %}
{% set universal_packages = packages|rejectattr('customer_type')|list + packages|selectattr('customer_type', 'equalto', 'both')|list %}

<div class="p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h5 class="mb-1"><i class="fa-solid fa-box"></i> Paquetes</h5>
            <p class="text-muted small mb-0">Paquetes y ofertas especiales por tipo de cliente</p>
        </div>
        <div class="d-flex gap-2">
            {% if show_inactive_packages %}
            <a href="?tab=packages&show_inactive_packages=0" class="btn btn-outline-secondary btn-sm">
                <i class="fa-solid fa-eye-slash"></i> Ocultar Inactivos
            </a>
            {% else %}
            <a href="?tab=packages&show_inactive_packages=1" class="btn btn-outline-secondary btn-sm">
                <i class="fa-solid fa-eye"></i> Ver Inactivos
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Internos (Hotel Guests) -->
    {{ package_section(
        'Huéspedes (Internos)',
        'fa-solid fa-hotel',
        'bg-success',
        interno_packages,
        'interno',
        show_inactive_packages
    ) }}

    <!-- Externos (Visitors) -->
    {{ package_section(
        'Visitantes (Externos)',
        'fa-solid fa-user',
        'bg-warning text-dark',
        externo_packages,
        'externo',
        show_inactive_packages
    ) }}

    <!-- Universal (Both/All) -->
    {{ package_section(
        'Universales (Todos)',
        'fa-solid fa-globe',
        'bg-secondary',
        universal_packages,
        'both',
        show_inactive_packages
    ) }}

    <!-- Info Card -->
    <div class="card mt-3">
        <div class="card-header">
            <h6 class="card-title mb-0"><i class="fa-solid fa-info-circle"></i> Cómo funciona</h6>
        </div>
        <div class="card-body">
            <ul class="mb-0 small">
                <li><strong>Huéspedes:</strong> Paquetes exclusivos para clientes internos (huéspedes del hotel)</li>
                <li><strong>Visitantes:</strong> Paquetes para clientes externos</li>
                <li><strong>Universales:</strong> Paquetes disponibles para todos los clientes</li>
                <li><strong>Prioridad:</strong> Los paquetes específicos tienen preferencia sobre los universales</li>
            </ul>
        </div>
    </div>
</div>
