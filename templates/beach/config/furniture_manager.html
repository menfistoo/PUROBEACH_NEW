{% extends "base.html" %}

{% set page_title = "Gestor de Mobiliario" %}

{% block title %}Gestor de Mobiliario - PuroBeach{% endblock %}

{% block extra_css %}
<style>
/* Tab Navigation */
.furniture-manager-tabs {
    border-bottom: 2px solid var(--color-accent, #F5E6D3);
    margin-bottom: 0;
    background: #fff;
    padding: 0 1rem;
}

.furniture-manager-tabs .nav-link {
    color: var(--color-secondary, #1A3A5C);
    border: none;
    border-bottom: 3px solid transparent;
    border-radius: 0;
    padding: 0.875rem 1.5rem;
    font-weight: 500;
    transition: all 0.2s ease;
    margin-bottom: -2px;
}

.furniture-manager-tabs .nav-link:hover {
    color: var(--color-primary, #D4AF37);
    border-bottom-color: rgba(212, 175, 55, 0.3);
    background: transparent;
}

.furniture-manager-tabs .nav-link.active {
    color: var(--color-primary, #D4AF37);
    background: transparent;
    border-bottom-color: var(--color-primary, #D4AF37);
}

.furniture-manager-tabs .nav-link i {
    margin-right: 0.5rem;
}

.tab-content {
    background: #f8f9fa;
}

.tab-pane {
    min-height: 500px;
}

/* Adjust map editor height within tab */
.tab-pane .editor-container {
    height: calc(100vh - 180px);
}
</style>

{# Map Editor CSS #}
{% include 'beach/config/_map_editor_css.html' %}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0"><i class="fas fa-tools me-2"></i>Gestor de Mobiliario</h4>
</div>

<!-- Tab Navigation -->
<ul class="nav nav-tabs furniture-manager-tabs" id="furnitureManagerTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'map-editor' %}active{% endif %}"
                id="map-editor-tab"
                data-bs-toggle="tab"
                data-bs-target="#map-editor-pane"
                type="button" role="tab"
                aria-controls="map-editor-pane"
                aria-selected="{{ 'true' if active_tab == 'map-editor' else 'false' }}">
            <i class="fas fa-drafting-compass"></i> Editor de Mapa
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'furniture-list' %}active{% endif %}"
                id="furniture-list-tab"
                data-bs-toggle="tab"
                data-bs-target="#furniture-list-pane"
                type="button" role="tab"
                aria-controls="furniture-list-pane"
                aria-selected="{{ 'true' if active_tab == 'furniture-list' else 'false' }}">
            <i class="fas fa-couch"></i> Lista de Mobiliario
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'furniture-types' %}active{% endif %}"
                id="furniture-types-tab"
                data-bs-toggle="tab"
                data-bs-target="#furniture-types-pane"
                type="button" role="tab"
                aria-controls="furniture-types-pane"
                aria-selected="{{ 'true' if active_tab == 'furniture-types' else 'false' }}">
            <i class="fas fa-shapes"></i> Tipos de Mobiliario
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'zones' %}active{% endif %}"
                id="zones-tab"
                data-bs-toggle="tab"
                data-bs-target="#zones-pane"
                type="button" role="tab"
                aria-controls="zones-pane"
                aria-selected="{{ 'true' if active_tab == 'zones' else 'false' }}">
            <i class="fas fa-layer-group"></i> Zonas
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="furnitureManagerTabContent">
    <!-- Map Editor Tab -->
    <div class="tab-pane fade {% if active_tab == 'map-editor' %}show active{% endif %}"
         id="map-editor-pane" role="tabpanel" aria-labelledby="map-editor-tab">
        {% include 'beach/config/_map_editor_tab.html' %}
    </div>

    <!-- Furniture List Tab -->
    <div class="tab-pane fade {% if active_tab == 'furniture-list' %}show active{% endif %}"
         id="furniture-list-pane" role="tabpanel" aria-labelledby="furniture-list-tab">
        {% include 'beach/config/_furniture_list_tab.html' %}
    </div>

    <!-- Furniture Types Tab -->
    <div class="tab-pane fade {% if active_tab == 'furniture-types' %}show active{% endif %}"
         id="furniture-types-pane" role="tabpanel" aria-labelledby="furniture-types-tab">
        {% include 'beach/config/_furniture_types_tab.html' %}
    </div>

    <!-- Zones Tab -->
    <div class="tab-pane fade {% if active_tab == 'zones' %}show active{% endif %}"
         id="zones-pane" role="tabpanel" aria-labelledby="zones-tab">
        {% include 'beach/config/_zones_tab.html' %}
    </div>
</div>

<!-- Zone Settings Modal (shared) -->
<div class="modal fade zone-settings-modal" id="zoneSettingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #1A3A5C 0%, #2A4A6C 100%);">
                <h5 class="modal-title text-white"><i class="fas fa-cog me-2"></i>Configuración de Zona</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label">Ancho del Canvas</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="zone-canvas-width" min="400" max="3000" step="50">
                            <span class="input-group-text">px</span>
                        </div>
                    </div>
                    <div class="col-6">
                        <label class="form-label">Alto del Canvas</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="zone-canvas-height" min="200" max="2000" step="50">
                            <span class="input-group-text">px</span>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Color de Fondo</label>
                    <div class="d-flex gap-2 align-items-center">
                        <input type="color" class="form-control form-control-color" id="zone-bg-color">
                        <div class="color-preview" id="zone-bg-preview" style="width: 40px; height: 40px; border-radius: 4px; border: 1px solid #dee2e6;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-save-zone-settings">
                    <i class="fas fa-save me-1"></i>Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Type Modal (for furniture types) -->
<div class="modal fade" id="deleteTypeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fa-solid fa-exclamation-triangle text-danger"></i> Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de eliminar este tipo de mobiliario?</p>
                <p class="text-muted small">
                    <i class="fa-solid fa-info-circle"></i>
                    Solo se puede eliminar si no hay mobiliario activo usando este tipo.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="delete-type-form" method="POST" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="fa-solid fa-trash"></i> Eliminar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="module" src="{{ url_for('static', filename='js/map-editor/index.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Track initialization state for each tab
    const tabState = {
        'map-editor': { initialized: false, editor: null },
        'furniture-list': { initialized: false },
        'furniture-types': { initialized: false, sortable: null },
        'zones': { initialized: false }
    };

    // Initialize the active tab
    const activeTab = '{{ active_tab }}';
    initializeTab(activeTab);

    // Handle tab shown events for lazy initialization
    document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
            const targetId = event.target.dataset.bsTarget.replace('#', '').replace('-pane', '');
            initializeTab(targetId);

            // Update URL without page reload for bookmarking
            const url = new URL(window.location);
            url.searchParams.set('tab', targetId);
            window.history.replaceState({}, '', url);
        });
    });

    function initializeTab(tabId) {
        if (tabState[tabId]?.initialized) return;

        console.log('Initializing tab:', tabId);

        switch(tabId) {
            case 'map-editor':
                initMapEditor();
                break;
            case 'furniture-list':
                initFurnitureList();
                break;
            case 'furniture-types':
                initFurnitureTypes();
                break;
            case 'zones':
                initZones();
                break;
        }

        tabState[tabId].initialized = true;
    }

    // ==========================================
    // MAP EDITOR TAB
    // ==========================================
    function initMapEditor() {
        const editor = new MapEditor('canvas-container', {
            paletteId: 'palette',
            propertiesPanelId: 'properties-panel',
            apiBaseUrl: '/beach/config/map-editor',
            snapToGrid: 25,
            showRulers: true
        });
        tabState['map-editor'].editor = editor;

        MapEditorUI.bindPaletteCollapse();
        MapEditorUI.bindZoneControls(editor, { emptyCanvasId: 'empty-canvas' });
        MapEditorUI.bindToolbarControls(editor);
        MapEditorUI.bindPropertyPanel(editor, {
            propertyIds: ['prop-x', 'prop-y', 'prop-rotation', 'prop-capacity', 'prop-width', 'prop-height']
        });
        MapEditorUI.bindColorPicker(editor, 'prop-fill-color', 'prop-fill-color-text', 'fill_color');

        const featureMgr = MapEditorUI.createFeatureManager(editor, '/beach/config/map-editor');
        MapEditorUI.bindDuplicate(editor);
        MapEditorUI.bindMultiSelectionToolbar(editor);
        MapEditorUI.bindEditorEvents(editor, {
            featureManager: featureMgr,
            hasSize: true,
            hasColor: true
        });
    }

    // ==========================================
    // FURNITURE LIST TAB
    // ==========================================
    function initFurnitureList() {
        // Furniture list is mostly server-rendered, minimal JS needed
        console.log('Furniture list tab initialized');
    }

    // ==========================================
    // ZONES TAB
    // ==========================================
    function initZones() {
        // Zones tab is mostly server-rendered, minimal JS needed
        // Color picker sync if form is present
        const colorPicker = document.getElementById('zone_color');
        const colorText = document.getElementById('zone_color_text');
        if (colorPicker && colorText) {
            colorPicker.addEventListener('input', function() {
                colorText.value = this.value;
            });
        }
        console.log('Zones tab initialized');
    }

    // ==========================================
    // FURNITURE TYPES TAB
    // ==========================================
    function initFurnitureTypes() {
        // Initialize Sortable for drag-drop reordering
        const listEl = document.getElementById('furniture-types-list');
        if (listEl && typeof Sortable !== 'undefined') {
            tabState['furniture-types'].sortable = new Sortable(listEl, {
                handle: '.drag-handle',
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                dragClass: 'sortable-drag',
                filter: 'a',
                preventOnFilter: false,
                forceFallback: true,
                onEnd: function(evt) {
                    saveTypesOrder();
                }
            });

            document.querySelectorAll('.drag-handle').forEach(handle => {
                handle.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });
        }

        function saveTypesOrder() {
            const items = document.querySelectorAll('#furniture-types-list li');
            const typeIds = Array.from(items).map(item => parseInt(item.dataset.typeId));

            fetch('{{ url_for("beach.beach_config.furniture_types_reorder") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({ type_ids: typeIds })
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error('Error reordering:', data.error);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // Initialize furniture type form if in edit/create mode
        initFurnitureTypeForm();
    }

    function initFurnitureTypeForm() {
        {% if mode %}
        // Icon picker
        document.querySelectorAll('.icon-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const icon = this.dataset.icon;
                const iconInput = document.getElementById('icon');
                const iconPreview = document.getElementById('icon-preview');
                if (iconInput) iconInput.value = icon;
                if (iconPreview) iconPreview.innerHTML = `<i class="fa-solid ${icon}"></i>`;
            });
        });

        // Color inputs sync
        function syncColorInput(colorId, textId) {
            const colorInput = document.getElementById(colorId);
            const textInput = document.getElementById(textId);
            if (colorInput && textInput) {
                colorInput.addEventListener('input', function() {
                    textInput.value = this.value;
                    updateSvgPreview();
                });
            }
        }
        syncColorInput('default_color', 'default_color_text');
        syncColorInput('fill_color', 'fill_color_text');
        syncColorInput('stroke_color', 'stroke_color_text');

        // Show/hide custom SVG field
        const mapShapeSelect = document.getElementById('map_shape');
        const customSvgWrapper = document.getElementById('custom_svg_wrapper');
        if (mapShapeSelect) {
            mapShapeSelect.addEventListener('change', function() {
                if (customSvgWrapper) customSvgWrapper.style.display = this.value === 'custom' ? 'block' : 'none';
                updateSvgPreview();
            });
            if (mapShapeSelect.value === 'custom' && customSvgWrapper) {
                customSvgWrapper.style.display = 'block';
            }
        }

        // Update SVG preview with debounce
        let previewTimeout;
        function updateSvgPreview() {
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(doUpdateSvgPreview, 300);
        }

        function doUpdateSvgPreview() {
            const data = {
                map_shape: document.getElementById('map_shape')?.value || 'rounded_rect',
                default_width: parseFloat(document.getElementById('default_width')?.value) || 60,
                default_height: parseFloat(document.getElementById('default_height')?.value) || 40,
                border_radius: parseInt(document.getElementById('border_radius')?.value) || 5,
                stroke_width: parseInt(document.getElementById('stroke_width')?.value) || 2,
                fill_color: document.getElementById('fill_color')?.value || '#A0522D',
                stroke_color: document.getElementById('stroke_color')?.value || '#654321',
                custom_svg: document.getElementById('custom_svg')?.value || ''
            };

            fetch('{{ url_for("beach.beach_config.furniture_types_preview") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const preview = document.getElementById('svg-preview');
                    if (preview) preview.innerHTML = data.preview;
                }
            })
            .catch(error => console.error('Error updating preview:', error));
        }

        // Trigger preview update on field changes
        ['map_shape', 'default_width', 'default_height', 'border_radius',
         'stroke_width', 'fill_color', 'stroke_color', 'custom_svg'].forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('input', updateSvgPreview);
                field.addEventListener('change', updateSvgPreview);
            }
        });

        updateSvgPreview();

        // Decorative toggle
        const decorativeCheckbox = document.getElementById('is_decorative');
        if (decorativeCheckbox) {
            decorativeCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    document.getElementById('min_capacity').value = 0;
                    document.getElementById('max_capacity').value = 0;
                    document.getElementById('default_capacity').value = 0;
                }
            });
        }

        // Form validation - open accordion sections with invalid fields
        const furnitureTypeForm = document.getElementById('furniture-type-form');
        if (furnitureTypeForm) {
            furnitureTypeForm.addEventListener('submit', function(e) {
                // Check if form is valid
                if (!furnitureTypeForm.checkValidity()) {
                    e.preventDefault();

                    // Find first invalid field
                    const invalidFields = furnitureTypeForm.querySelectorAll(':invalid');
                    if (invalidFields.length > 0) {
                        const firstInvalid = invalidFields[0];
                        const accordionCollapse = firstInvalid.closest('.accordion-collapse');

                        // If field is in a collapsed accordion, open it first
                        if (accordionCollapse && !accordionCollapse.classList.contains('show')) {
                            const bsCollapse = new bootstrap.Collapse(accordionCollapse, { toggle: true });
                            accordionCollapse.addEventListener('shown.bs.collapse', function() {
                                firstInvalid.focus();
                                firstInvalid.reportValidity();
                            }, { once: true });
                        } else {
                            // Accordion already open, just focus and show error
                            firstInvalid.focus();
                            firstInvalid.reportValidity();
                        }
                    }
                }
            });
        }
        {% endif %}
    }
});
</script>
{% endblock %}
