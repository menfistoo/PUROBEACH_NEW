{# Macro for policy table rows #}
{% macro policy_row(policy) %}
<tr class="{% if not policy.is_active %}table-secondary{% endif %}">
    <td>
        <strong>{{ policy.policy_name }}</strong>
        {% if policy.policy_description %}
        <br><small class="text-muted">{{ policy.policy_description[:60] }}{% if policy.policy_description|length > 60 %}...{% endif %}</small>
        {% endif %}
    </td>
    <td class="text-end">
        <strong>{{ "%.2f"|format(policy.minimum_amount) }} €</strong>
        {% if policy.calculation_type == 'per_person' %}
        <small class="text-muted">/pers</small>
        {% endif %}
    </td>
    <td class="text-center">
        <small class="text-muted">{{ policy.furniture_type_name or policy.furniture_type or 'Todos' }}</small>
    </td>
    <td class="text-center">
        <small class="text-muted">{{ policy.zone_name or 'Todas' }}</small>
    </td>
    <td class="text-center">
        {% if policy.is_active %}
        <span class="badge bg-success">Activa</span>
        {% else %}
        <span class="badge bg-secondary">Inactiva</span>
        {% endif %}
    </td>
    <td class="text-center">
        <a href="{{ url_for('beach.beach_config.minimum_consumption_edit', policy_id=policy.id) }}"
           class="btn btn-sm btn-outline-primary" title="Editar">
            <i class="fa-solid fa-edit"></i>
        </a>
        <form method="POST" action="{{ url_for('beach.beach_config.minimum_consumption_delete', policy_id=policy.id) }}"
              class="d-inline" onsubmit="return confirm('¿Eliminar política {{ policy.policy_name }}?')">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-sm btn-outline-danger" title="Eliminar">
                <i class="fa-solid fa-trash"></i>
            </button>
        </form>
    </td>
</tr>
{% endmacro %}

{# Macro for policy section #}
{% macro policy_section(title, icon, badge_class, policies_list, customer_type_param, show_inactive) %}
<div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
            <i class="{{ icon }} me-2"></i>{{ title }}
            <span class="badge {{ badge_class }} ms-2">{{ policies_list|length }}</span>
        </h6>
        <a href="{{ url_for('beach.beach_config.minimum_consumption_create', customer_type=customer_type_param) }}"
           class="btn btn-sm btn-outline-primary">
            <i class="fa-solid fa-plus"></i> Añadir
        </a>
    </div>
    {% if policies_list %}
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th class="text-end" style="width: 120px;">Monto</th>
                        <th class="text-center" style="width: 100px;">Mobiliario</th>
                        <th class="text-center" style="width: 100px;">Zona</th>
                        <th class="text-center" style="width: 80px;">Estado</th>
                        <th class="text-center" style="width: 100px;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for policy in policies_list %}
                    {{ policy_row(policy) }}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="card-body text-center py-4">
        <p class="text-muted mb-0 small">Sin políticas configuradas</p>
    </div>
    {% endif %}
</div>
{% endmacro %}

{# Group policies by customer type #}
{% set interno_policies = policies|selectattr('customer_type', 'equalto', 'interno')|list %}
{% set externo_policies = policies|selectattr('customer_type', 'equalto', 'externo')|list %}
{% set universal_policies = policies|rejectattr('customer_type')|list %}

<div class="p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h5 class="mb-1"><i class="fa-solid fa-euro-sign"></i> Consumo Mínimo</h5>
            <p class="text-muted small mb-0">Políticas de consumo mínimo por tipo de cliente</p>
        </div>
        <div class="d-flex gap-2">
            {% if show_inactive_policies %}
            <a href="?tab=minimum-consumption&show_inactive_policies=0" class="btn btn-outline-secondary btn-sm">
                <i class="fa-solid fa-eye-slash"></i> Ocultar Inactivas
            </a>
            {% else %}
            <a href="?tab=minimum-consumption&show_inactive_policies=1" class="btn btn-outline-secondary btn-sm">
                <i class="fa-solid fa-eye"></i> Ver Inactivas
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Internos (Hotel Guests) -->
    {{ policy_section(
        'Huéspedes (Internos)',
        'fa-solid fa-hotel',
        'bg-success',
        interno_policies,
        'interno',
        show_inactive_policies
    ) }}

    <!-- Externos (Visitors) -->
    {{ policy_section(
        'Visitantes (Externos)',
        'fa-solid fa-user',
        'bg-warning text-dark',
        externo_policies,
        'externo',
        show_inactive_policies
    ) }}

    <!-- Universal (All) -->
    {{ policy_section(
        'Universales (Todos)',
        'fa-solid fa-globe',
        'bg-secondary',
        universal_policies,
        '',
        show_inactive_policies
    ) }}

    <!-- Info Card -->
    <div class="card mt-3">
        <div class="card-header">
            <h6 class="card-title mb-0"><i class="fa-solid fa-info-circle"></i> Cómo funciona</h6>
        </div>
        <div class="card-body">
            <ul class="mb-0 small">
                <li><strong>Huéspedes:</strong> Políticas para clientes internos (huéspedes del hotel)</li>
                <li><strong>Visitantes:</strong> Políticas para clientes externos</li>
                <li><strong>Universales:</strong> Aplican a todos si no hay política específica</li>
                <li><strong>Prioridad:</strong> Primero se busca política específica, luego universal</li>
            </ul>
        </div>
    </div>
</div>
