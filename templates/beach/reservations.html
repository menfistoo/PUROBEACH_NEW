{% extends "base.html" %}

{% set page_title = "Gestión de Reservas" %}

{% block title %}Gestión de Reservas - PuroBeach{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="fas fa-calendar-check"></i> Gestión de Reservas</h2>
        <p class="text-muted mb-0">
            {% if date_from %}
            Reservas del {{ date_from }}{% if date_to and date_to != date_from %} al {{ date_to }}{% endif %}
            {% else %}
            Reservas de hoy
            {% endif %}
        </p>
    </div>
    <a href="{{ url_for('beach.reservations_create') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Nueva Reserva
    </a>
</div>

<!-- Stats Cards -->
{% if stats %}
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small text-white-50">Total Reservas</div>
                        <div class="h3 mb-0">{{ stats.total }}</div>
                    </div>
                    <i class="fas fa-calendar-day fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small text-white-50">Confirmadas</div>
                        <div class="h3 mb-0">{{ stats.confirmadas or 0 }}</div>
                    </div>
                    <i class="fas fa-check-circle fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small text-white-50">Internos</div>
                        <div class="h3 mb-0">{{ stats.interno or 0 }}</div>
                    </div>
                    <i class="fas fa-hotel fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small">Externos</div>
                        <div class="h3 mb-0">{{ stats.externo or 0 }}</div>
                    </div>
                    <i class="fas fa-user fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- State summary pills -->
{% if stats.by_state is mapping %}
<div class="mb-4">
    <div class="d-flex flex-wrap gap-2">
        {% for state_name, count in stats.by_state.items() %}
        {% if count > 0 %}
        <span class="badge bg-secondary" style="font-size: 0.9em;">
            {{ state_name }}: {{ count }}
        </span>
        {% endif %}
        {% endfor %}
    </div>
</div>
{% endif %}
{% endif %}

<!-- Filters -->
<div class="card mb-3">
    <div class="card-body">
        <form method="GET" action="{{ url_for('beach.reservations') }}" class="row g-3">
            <div class="col-md-2">
                <label class="form-label small">Desde</label>
                <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
            </div>
            <div class="col-md-2">
                <label class="form-label small">Hasta</label>
                <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
            </div>
            <div class="col-md-2">
                <label class="form-label small">Estado</label>
                <select name="state" class="form-select">
                    <option value="">Todos</option>
                    {% for state in states %}
                    <option value="{{ state.name }}" {% if state_filter == state.name %}selected{% endif %}>
                        {{ state.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small">Tipo Cliente</label>
                <select name="type" class="form-select">
                    <option value="">Todos</option>
                    <option value="interno" {% if type_filter == 'interno' %}selected{% endif %}>Interno</option>
                    <option value="externo" {% if type_filter == 'externo' %}selected{% endif %}>Externo</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small">Buscar</label>
                <input type="text" name="search" class="form-control" placeholder="Cliente, ticket..."
                       value="{{ search }}">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-secondary w-100">
                    <i class="fas fa-search"></i> Filtrar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Results count -->
<div class="mb-3 text-muted">
    <small>Mostrando {{ reservations|length }} de {{ total }} reservas</small>
</div>

<!-- Reservations Table -->
<div class="card">
    <div class="table-responsive">
        <table class="table table-striped table-hover mb-0">
            <thead>
                <tr>
                    <th>Ticket</th>
                    <th>Cliente</th>
                    <th>Fecha</th>
                    <th>Personas</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for res in reservations %}
                <tr>
                    <td>
                        <a href="{{ url_for('beach.reservations_detail', reservation_id=res.id) }}"
                           class="text-decoration-none">
                            <strong>{{ res.ticket_number or '#' ~ res.id }}</strong>
                        </a>
                    </td>
                    <td>
                        <div>
                            <strong>{{ res.customer_name }}</strong>
                        </div>
                        <small class="text-muted">
                            {% if res.customer_type == 'interno' %}
                            <i class="fas fa-hotel"></i> Hab. {{ res.room_number or '-' }}
                            {% else %}
                            <i class="fas fa-user"></i> Externo
                            {% endif %}
                        </small>
                    </td>
                    <td>
                        <div>{{ res.reservation_date or res.start_date }}</div>
                        {% if res.time_slot and res.time_slot != 'all_day' %}
                        <small class="text-muted">
                            {% if res.time_slot == 'morning' %}Mañana{% elif res.time_slot == 'afternoon' %}Tarde{% endif %}
                        </small>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge bg-secondary">
                            <i class="fas fa-users"></i> {{ res.num_people }}
                        </span>
                    </td>
                    <td>
                        <span class="badge" style="background-color: {{ res.display_color or '#6C757D' }}">
                            {{ res.current_state or 'Sin estado' }}
                        </span>
                        {% if res.current_states and ',' in res.current_states %}
                        <br><small class="text-muted" title="{{ res.current_states }}">
                            +{{ res.current_states.split(',')|length - 1 }} más
                        </small>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="{{ url_for('beach.reservations_detail', reservation_id=res.id) }}"
                               class="btn btn-outline-primary" title="Ver detalle">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="{{ url_for('beach.reservations_edit', reservation_id=res.id) }}"
                               class="btn btn-outline-secondary" title="Editar">
                                <i class="fas fa-edit"></i>
                            </a>
                            <form method="POST"
                                  action="{{ url_for('beach.reservations_delete', reservation_id=res.id) }}"
                                  class="d-inline"
                                  onsubmit="return confirm('¿Está seguro de eliminar esta reserva?')">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-outline-danger" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center text-muted py-5">
                        <i class="fas fa-calendar-xmark fa-3x mb-3 d-block opacity-50"></i>
                        No se encontraron reservas
                        {% if search or date_from or date_to or state_filter or type_filter %}
                        <br><small>Pruebe con otros filtros</small>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if pages|default(0) > 1 %}
<nav class="mt-3">
    <ul class="pagination justify-content-center">
        {% if page > 1 %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('beach.reservations', page=page-1, date_from=date_from, date_to=date_to, type=type_filter, state=state_filter, search=search) }}">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
        {% endif %}

        {% for p in range(1, pages + 1) %}
        {% if p == page %}
        <li class="page-item active"><span class="page-link">{{ p }}</span></li>
        {% elif p == 1 or p == pages or (p >= page - 2 and p <= page + 2) %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('beach.reservations', page=p, date_from=date_from, date_to=date_to, type=type_filter, state=state_filter, search=search) }}">{{ p }}</a>
        </li>
        {% elif p == page - 3 or p == page + 3 %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
        {% endfor %}

        {% if page < pages %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('beach.reservations', page=page+1, date_from=date_from, date_to=date_to, type=type_filter, state=state_filter, search=search) }}">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}
{% endblock %}
