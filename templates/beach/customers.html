{% extends "base.html" %}

{% set page_title = "Gestión de Clientes" %}

{% block title %}Gestión de Clientes - PuroBeach{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="fas fa-address-book"></i> Gestión de Clientes</h2>
        <p class="text-muted mb-0">Administración de clientes internos y externos</p>
    </div>
    <a href="{{ url_for('beach.customers_create') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Nuevo Cliente
    </a>
</div>

<!-- Stats Cards -->
{% if stats %}
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small text-white-50">Total Clientes</div>
                        <div class="h3 mb-0">{{ stats.total }}</div>
                    </div>
                    <i class="fas fa-users fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small text-white-50">Internos</div>
                        <div class="h3 mb-0">{{ stats.interno }}</div>
                    </div>
                    <i class="fas fa-hotel fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small text-white-50">Externos</div>
                        <div class="h3 mb-0">{{ stats.externo }}</div>
                    </div>
                    <i class="fas fa-user-friends fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small">VIP</div>
                        <div class="h3 mb-0">{{ stats.vip }}</div>
                    </div>
                    <i class="fas fa-star fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Filters -->
<div class="card mb-3">
    <div class="card-body">
        <form id="customerFilterForm" method="GET" action="{{ url_for('beach.customers') }}" class="row g-3">
            <div class="col-md-5">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" name="search" id="searchInput" class="form-control"
                           placeholder="Buscar por nombre, teléfono, email o habitación"
                           value="{{ search }}">
                    <span class="input-group-text d-none" id="searchSpinner">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    </span>
                </div>
            </div>
            <div class="col-md-3">
                <select name="type" id="typeFilter" class="form-select">
                    <option value="">Todos los tipos</option>
                    <option value="interno" {% if type_filter == 'interno' %}selected{% endif %}>
                        Interno (Huésped)
                    </option>
                    <option value="externo" {% if type_filter == 'externo' %}selected{% endif %}>
                        Externo
                    </option>
                </select>
            </div>
            <div class="col-md-3">
                <div class="form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" name="vip" value="1"
                           id="vipFilter" {% if vip_filter == '1' %}checked{% endif %}>
                    <label class="form-check-label" for="vipFilter">Solo VIP</label>
                </div>
            </div>
            <div class="col-md-1">
                <noscript>
                    <button type="submit" class="btn btn-secondary w-100">
                        <i class="fas fa-search"></i>
                    </button>
                </noscript>
            </div>
        </form>
    </div>
</div>

<!-- Results count -->
<div class="mb-3 text-muted" id="resultsCount">
    <small>Mostrando {{ customers|length }} de {{ total }} clientes</small>
</div>

<!-- Customer Table -->
<div class="card">
    <div class="table-responsive">
        <table class="table table-striped table-hover mb-0">
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Tipo</th>
                    <th>Contacto</th>
                    <th>Habitación</th>
                    <th>VIP</th>
                    <th>Reservas</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="customerTableBody">
                {% for customer in customers %}
                <tr>
                    <td>
                        <a href="{{ url_for('beach.customers_detail', customer_id=customer.id) }}"
                           class="text-decoration-none">
                            <strong>{{ customer.first_name }} {{ customer.last_name or '' }}</strong>
                        </a>
                    </td>
                    <td>
                        {% if customer.customer_type == 'interno' %}
                        <span class="badge bg-info">
                            <i class="fas fa-hotel"></i> Interno
                        </span>
                        {% else %}
                        <span class="badge bg-success">
                            <i class="fas fa-user"></i> Externo
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if customer.phone %}
                        <div><i class="fas fa-phone text-muted me-1"></i> {{ customer.phone }}</div>
                        {% endif %}
                        {% if customer.email %}
                        <div><i class="fas fa-envelope text-muted me-1"></i> {{ customer.email }}</div>
                        {% endif %}
                    </td>
                    <td>
                        {% if customer.room_number %}
                        <span class="badge bg-secondary">
                            <i class="fas fa-door-open"></i> {{ customer.room_number }}
                        </span>
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if customer.vip_status %}
                        <span class="badge bg-warning text-dark">
                            <i class="fas fa-star"></i> VIP
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge bg-secondary">
                            {{ customer.reservation_count or 0 }}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="{{ url_for('beach.customers_detail', customer_id=customer.id) }}"
                               class="btn btn-outline-primary" title="Ver detalle">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="{{ url_for('beach.customers_edit', customer_id=customer.id) }}"
                               class="btn btn-outline-secondary" title="Editar">
                                <i class="fas fa-edit"></i>
                            </a>
                            <form method="POST"
                                  action="{{ url_for('beach.customers_delete', customer_id=customer.id) }}"
                                  class="d-inline"
                                  onsubmit="return confirm('¿Está seguro de eliminar este cliente?')">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-outline-danger" title="Eliminar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="text-center text-muted py-5">
                        <i class="fas fa-users fa-3x mb-3 d-block opacity-50"></i>
                        No se encontraron clientes
                        {% if search or type_filter or vip_filter %}
                        <br><small>Pruebe con otros filtros</small>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
/**
 * CustomerListAutoFilter - Auto-filtering for customer list page
 * Text inputs: 300ms debounce
 * Select/checkbox: immediate filter
 */
(function() {
    'use strict';

    const DEBOUNCE_DELAY = 300;
    const API_URL = '/beach/api/customers/list';

    // DOM elements
    const searchInput = document.getElementById('searchInput');
    const typeFilter = document.getElementById('typeFilter');
    const vipFilter = document.getElementById('vipFilter');
    const searchSpinner = document.getElementById('searchSpinner');
    const resultsCount = document.getElementById('resultsCount');
    const tableBody = document.getElementById('customerTableBody');
    const form = document.getElementById('customerFilterForm');

    let debounceTimer = null;
    let currentRequest = null;

    /**
     * Show loading indicator
     */
    function showLoading() {
        searchSpinner.classList.remove('d-none');
        tableBody.style.opacity = '0.5';
    }

    /**
     * Hide loading indicator
     */
    function hideLoading() {
        searchSpinner.classList.add('d-none');
        tableBody.style.opacity = '1';
    }

    /**
     * Get current filter values
     */
    function getFilterValues() {
        return {
            search: searchInput.value.trim(),
            type: typeFilter.value,
            vip: vipFilter.checked ? '1' : ''
        };
    }

    /**
     * Build URL with query parameters
     */
    function buildUrl(filters) {
        const params = new URLSearchParams();
        if (filters.search) params.set('search', filters.search);
        if (filters.type) params.set('type', filters.type);
        if (filters.vip) params.set('vip', filters.vip);
        return `${API_URL}?${params.toString()}`;
    }

    /**
     * Update browser URL without page reload
     */
    function updateBrowserUrl(filters) {
        const params = new URLSearchParams();
        if (filters.search) params.set('search', filters.search);
        if (filters.type) params.set('type', filters.type);
        if (filters.vip) params.set('vip', filters.vip);
        const newUrl = params.toString() ? `?${params.toString()}` : window.location.pathname;
        window.history.replaceState({}, '', newUrl);
    }

    /**
     * Render customer row HTML
     */
    function renderCustomerRow(customer) {
        const fullName = `${customer.first_name} ${customer.last_name || ''}`.trim();
        const detailUrl = `/beach/customers/${customer.id}`;
        const editUrl = `/beach/customers/${customer.id}/edit`;
        const deleteUrl = `/beach/customers/${customer.id}/delete`;

        // Type badge
        const typeBadge = customer.customer_type === 'interno'
            ? '<span class="badge bg-info"><i class="fas fa-hotel"></i> Interno</span>'
            : '<span class="badge bg-success"><i class="fas fa-user"></i> Externo</span>';

        // Contact info
        let contactHtml = '';
        if (customer.phone) {
            contactHtml += `<div><i class="fas fa-phone text-muted me-1"></i> ${escapeHtml(customer.phone)}</div>`;
        }
        if (customer.email) {
            contactHtml += `<div><i class="fas fa-envelope text-muted me-1"></i> ${escapeHtml(customer.email)}</div>`;
        }

        // Room number
        const roomHtml = customer.room_number
            ? `<span class="badge bg-secondary"><i class="fas fa-door-open"></i> ${escapeHtml(customer.room_number)}</span>`
            : '<span class="text-muted">-</span>';

        // VIP badge
        const vipHtml = customer.vip_status
            ? '<span class="badge bg-warning text-dark"><i class="fas fa-star"></i> VIP</span>'
            : '';

        // CSRF token for delete form
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        return `
            <tr>
                <td>
                    <a href="${detailUrl}" class="text-decoration-none">
                        <strong>${escapeHtml(fullName)}</strong>
                    </a>
                </td>
                <td>${typeBadge}</td>
                <td>${contactHtml || '<span class="text-muted">-</span>'}</td>
                <td>${roomHtml}</td>
                <td>${vipHtml}</td>
                <td><span class="badge bg-secondary">${customer.reservation_count || 0}</span></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <a href="${detailUrl}" class="btn btn-outline-primary" title="Ver detalle">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="${editUrl}" class="btn btn-outline-secondary" title="Editar">
                            <i class="fas fa-edit"></i>
                        </a>
                        <form method="POST" action="${deleteUrl}" class="d-inline"
                              onsubmit="return confirm('¿Está seguro de eliminar este cliente?')">
                            <input type="hidden" name="csrf_token" value="${csrfToken}">
                            <button type="submit" class="btn btn-outline-danger" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
        `;
    }

    /**
     * Render empty state
     */
    function renderEmptyState(hasFilters) {
        const filterHint = hasFilters ? '<br><small>Pruebe con otros filtros</small>' : '';
        return `
            <tr>
                <td colspan="7" class="text-center text-muted py-5">
                    <i class="fas fa-users fa-3x mb-3 d-block opacity-50"></i>
                    No se encontraron clientes
                    ${filterHint}
                </td>
            </tr>
        `;
    }

    /**
     * Escape HTML to prevent XSS
     */
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    /**
     * Perform the filter request
     */
    async function performFilter() {
        const filters = getFilterValues();

        // Abort previous request if still pending
        if (currentRequest) {
            currentRequest.abort();
        }

        showLoading();
        const controller = new AbortController();
        currentRequest = controller;

        try {
            const response = await fetch(buildUrl(filters), {
                signal: controller.signal
            });

            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor');
            }

            const data = await response.json();

            // Update results count
            resultsCount.innerHTML = `<small>Mostrando ${data.count} de ${data.total} clientes</small>`;

            // Update table body
            if (data.customers.length === 0) {
                const hasFilters = filters.search || filters.type || filters.vip;
                tableBody.innerHTML = renderEmptyState(hasFilters);
            } else {
                tableBody.innerHTML = data.customers.map(renderCustomerRow).join('');
            }

            // Update browser URL
            updateBrowserUrl(filters);

        } catch (error) {
            if (error.name === 'AbortError') {
                // Request was aborted, ignore
                return;
            }
            console.error('Error filtering customers:', error);
        } finally {
            hideLoading();
            currentRequest = null;
        }
    }

    /**
     * Handle text input with debounce
     */
    function handleTextInput() {
        if (debounceTimer) {
            clearTimeout(debounceTimer);
        }
        debounceTimer = setTimeout(performFilter, DEBOUNCE_DELAY);
    }

    /**
     * Handle select/checkbox change (immediate)
     */
    function handleImmediateChange() {
        if (debounceTimer) {
            clearTimeout(debounceTimer);
        }
        performFilter();
    }

    // Event listeners
    searchInput.addEventListener('input', handleTextInput);
    typeFilter.addEventListener('change', handleImmediateChange);
    vipFilter.addEventListener('change', handleImmediateChange);

    // Prevent form submission (use AJAX instead)
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        performFilter();
    });

})();
</script>
{% endblock %}
