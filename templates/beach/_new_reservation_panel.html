{#
    New Reservation Panel Partial
    A slide-in panel for creating new reservations from the map
    Consistent with ReservationPanel design pattern
#}

<!-- Panel Backdrop -->
<div class="new-reservation-panel-backdrop" id="newReservationPanelBackdrop"></div>

<!-- New Reservation Panel -->
<div class="new-reservation-panel" id="newReservationPanel" role="dialog" aria-labelledby="newPanelTitle" aria-modal="true">
    <!-- Collapsed bar - always visible in the 48px strip when collapsed -->
    <div class="collapsed-bar">
        <button type="button" class="collapse-toggle" id="newReservationCollapseBtn" title="Colapsar panel" aria-label="Colapsar panel">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>

    <!-- Header -->
    <div class="panel-header">
        <button type="button" class="collapse-toggle" id="newReservationCollapseBtnHeader" title="Colapsar panel" aria-label="Colapsar panel">
            <i class="fas fa-chevron-right"></i>
        </button>
        <button type="button" class="panel-close-btn" id="newPanelCloseBtn"
                aria-label="Cerrar panel" title="Cerrar">
            <i class="fas fa-xmark"></i>
        </button>
        <div class="panel-title">
            <span class="panel-ticket" id="newPanelTitle">Nueva Reserva</span>
            <span class="panel-date" id="newPanelDate"></span>
        </div>
        <div style="width: 44px;"></div> <!-- Spacer for symmetry -->
    </div>

    <!-- Body (scrollable) -->
    <div class="panel-body">
        <!-- Panel Content -->
        <div class="panel-content" id="newPanelContent">

            <!-- Furniture Section -->
            <section class="panel-section furniture-section">
                <div class="panel-section-title">
                    <i class="fas fa-umbrella-beach"></i>
                    Mobiliario Seleccionado
                </div>
                <div class="furniture-chips" id="newPanelFurnitureChips">
                    <!-- Furniture chips populated dynamically -->
                </div>
                <div class="furniture-summary" id="newPanelFurnitureSummary"></div>
            </section>

            <!-- Customer Section - Uses shared CustomerSearch component -->
            <section class="panel-section customer-section">
                <div class="panel-section-title">
                    <i class="fas fa-user"></i>
                    Cliente
                    <button type="button" class="customer-clear-btn" id="newPanelCustomerClearBtn"
                            style="display: none;" title="Cambiar cliente">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <!-- Customer Search (shown when no customer selected) -->
                <div class="customer-search-wrapper" id="newPanelCustomerWrapper">
                    <input type="text"
                           id="newPanelCustomerSearch"
                           class="form-control"
                           placeholder="Buscar cliente por nombre, habitacion o telefono..."
                           autocomplete="off">
                    <div class="customer-search-results cs-results" id="newPanelCustomerResults"></div>
                </div>
                <!-- Inline Create Customer Form (shown when clicking create button) -->
                <div class="create-customer-inline" id="newPanelCreateCustomerForm" style="display: none;">
                    <div class="create-form-header">
                        <span><i class="fas fa-user-plus"></i> Nuevo Cliente Externo</span>
                        <button type="button" class="create-form-cancel" id="newPanelCancelCreateBtn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="create-form-body">
                        <div class="create-form-row">
                            <div class="create-form-group">
                                <label>Nombre *</label>
                                <input type="text" id="newCustFirstName" class="form-control form-control-sm" placeholder="Nombre">
                            </div>
                            <div class="create-form-group">
                                <label>Apellido</label>
                                <input type="text" id="newCustLastName" class="form-control form-control-sm" placeholder="Apellido">
                            </div>
                        </div>
                        <div class="create-form-row">
                            <div class="create-form-group">
                                <label>Telefono *</label>
                                <input type="tel" id="newCustPhone" class="form-control form-control-sm" placeholder="+34 600 000 000">
                            </div>
                            <div class="create-form-group">
                                <label>Email</label>
                                <input type="email" id="newCustEmail" class="form-control form-control-sm" placeholder="email@ejemplo.com">
                            </div>
                        </div>
                        <div class="create-form-row">
                            <div class="create-form-group">
                                <label>Idioma</label>
                                <select id="newCustLanguage" class="form-select form-select-sm">
                                    <option value="">Seleccionar...</option>
                                    <option value="es">Espanol</option>
                                    <option value="en">English</option>
                                    <option value="de">Deutsch</option>
                                    <option value="fr">Francais</option>
                                </select>
                            </div>
                        </div>
                        <div class="create-form-error" id="newCustError" style="display: none;"></div>
                        <button type="button" class="btn btn-primary btn-sm w-100" id="newPanelSaveCustomerBtn">
                            <i class="fas fa-check"></i> Crear Cliente
                        </button>
                    </div>
                </div>
                <!-- Guest Selector for hotel rooms with multiple guests -->
                <div class="guest-selector-wrapper" id="newPanelGuestSelectorWrapper" style="display: none;">
                    <div class="guest-selector-row">
                        <i class="fas fa-user-friends"></i>
                        <span class="guest-count-text">
                            <span id="newPanelGuestCount">2</span> huespedes en habitacion:
                        </span>
                        <select id="newPanelGuestSelector" class="form-select form-select-sm"></select>
                    </div>
                </div>
                <!-- Selected Customer Display (shown after selection) -->
                <div class="customer-selected-display" id="newPanelCustomerDisplay" style="display: none;">
                    <div class="customer-display-compact">
                        <div class="customer-main-info">
                            <div class="customer-name" id="newPanelCustomerName">-</div>
                            <div class="customer-meta" id="newPanelCustomerMeta"></div>
                        </div>
                    </div>
                    <div class="customer-details-inline" id="newPanelCustomerDetailsGrid">
                        <span class="detail-inline" id="newPanelRoomItem">
                            <i class="fas fa-door-open"></i>
                            <span id="newPanelCustomerRoom">-</span>
                        </span>
                        <span class="detail-inline" id="newPanelCheckinItem">
                            <i class="fas fa-calendar-check"></i>
                            <span id="newPanelCustomerCheckin">-</span>
                        </span>
                        <span class="detail-inline" id="newPanelCheckoutItem">
                            <span class="detail-separator">-</span>
                            <span id="newPanelCustomerCheckout">-</span>
                        </span>
                        <span class="detail-inline" id="newPanelBookingItem" style="display: none;">
                            <i class="fas fa-hashtag"></i>
                            <span id="newPanelCustomerBookingRef">-</span>
                        </span>
                    </div>
                </div>
                <!-- Hidden elements for backwards compatibility -->
                <span id="newPanelCustomerAvatar" style="display:none;"><span id="newPanelCustomerInitials"></span></span>
                <input type="hidden" id="newPanelCustomerId" value="">
                <input type="hidden" id="newPanelCustomerSource" value="customer">
            </section>

            <!-- Date Section - Uses shared DatePicker component -->
            <section class="panel-section date-section">
                <div class="panel-section-title">
                    <i class="fas fa-calendar-alt"></i>
                    Fechas
                </div>
                <div id="newPanelDatePicker">
                    <!-- DatePicker component will be initialized here -->
                </div>
            </section>

            <!-- Details Section -->
            <section class="panel-section details-section">
                <div class="panel-section-title">
                    <i class="fas fa-info-circle"></i>
                    Detalles
                </div>
                <div class="details-grid">
                    <div class="detail-item">
                        <label class="detail-label" for="newPanelNumPeople">Personas</label>
                        <input type="number"
                               class="detail-input"
                               id="newPanelNumPeople"
                               min="1"
                               max="20"
                               value="2">
                    </div>
                    <div class="detail-item full-width">
                        <label class="detail-label" for="newPanelNotes">Notas</label>
                        <textarea class="notes-textarea"
                                  id="newPanelNotes"
                                  placeholder="Agregar notas sobre la reserva..."></textarea>
                    </div>
                </div>
            </section>

            <!-- Pricing Section -->
            <section class="panel-section pricing-section">
                <div class="panel-section-title">
                    <i class="fas fa-euro-sign"></i>
                    Precio
                </div>
                <div class="pricing-display" id="newPanelPricingDisplay">
                    <div class="pricing-loading" style="display: none;">
                        <span class="spinner-border spinner-border-sm"></span>
                        Calculando precio...
                    </div>
                    <div class="pricing-content" id="newPanelPricingContent">
                        <!-- Package Selection Dropdown -->
                        <div class="pricing-type-selector" id="newPanelPricingTypeSelector" style="display: none;">
                            <label class="detail-label" for="newPanelPricingTypeSelect">Tipo de precio:</label>
                            <select class="form-select pricing-select" id="newPanelPricingTypeSelect">
                                <option value="">Consumo mínimo</option>
                                <!-- Package options populated dynamically -->
                            </select>
                        </div>

                        <!-- Price Display with Edit Option -->
                        <div class="pricing-row pricing-amount">
                            <div class="pricing-display-group">
                                <label class="detail-label">Precio final:</label>
                                <div class="pricing-input-group">
                                    <span class="pricing-currency" aria-hidden="true">€</span>
                                    <input type="number"
                                           class="pricing-input"
                                           id="newPanelFinalPriceInput"
                                           min="0"
                                           step="0.01"
                                           placeholder="0.00"
                                           aria-label="Precio final en euros">
                                    <button type="button"
                                            class="pricing-reset-btn"
                                            id="newPanelPriceResetBtn"
                                            title="Restablecer precio calculado"
                                            aria-label="Restablecer precio calculado"
                                            style="display: none;">
                                        <i class="fas fa-undo" aria-hidden="true"></i>
                                    </button>
                                </div>
                                <div class="pricing-calculated" id="newPanelCalculatedPrice" style="display: none;">
                                    Precio calculado: <span class="calculated-amount">€0.00</span>
                                </div>
                            </div>
                        </div>
                        <div class="pricing-breakdown" id="newPanelPricingBreakdown" style="display: none;" aria-live="polite"></div>
                        <input type="hidden" id="newPanelPriceOverride" value="">
                    </div>
                </div>
                <input type="hidden" id="newPanelSelectedPackageId" value="">
            </section>

            <!-- Payment Section -->
            <section class="panel-section payment-section">
                <div class="panel-section-title">
                    <i class="fas fa-receipt"></i>
                    Pago
                </div>
                <div class="details-grid">
                    <div class="detail-item">
                        <label class="detail-label" for="newPanelPaymentTicket">Nº ticket</label>
                        <input type="text"
                               class="detail-input"
                               id="newPanelPaymentTicket"
                               placeholder="Ej: 12345">
                    </div>
                    <div class="detail-item">
                        <label class="detail-label" for="newPanelPaymentMethod">Forma de pago</label>
                        <select class="form-select detail-input" id="newPanelPaymentMethod">
                            <option value="">Seleccionar...</option>
                            <option value="efectivo">Efectivo</option>
                            <option value="tarjeta">Tarjeta</option>
                            <option value="cargo_habitacion">Cargo a habitación</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- Preferences Section -->
            <section class="panel-section preferences-section">
                <div class="panel-section-title">
                    <i class="fas fa-star"></i>
                    Preferencias
                </div>
                <div class="preference-chips" id="newPanelPreferenceChips">
                    <!-- Dynamically loaded from /beach/api/preferences -->
                    <span class="text-muted small">Cargando...</span>
                </div>
                <input type="hidden" id="newPanelPreferences" value="">
            </section>

            <!-- Tags Section -->
            <section class="panel-section tags-section">
                <div class="panel-section-title">
                    <i class="fas fa-tags"></i>
                    Etiquetas
                </div>
                <div class="tag-chips" id="newPanelTagChips">
                    <!-- Dynamically loaded from /beach/api/tags -->
                    <span class="text-muted small">Cargando...</span>
                </div>
            </section>

        </div>
    </div>

    <!-- Footer -->
    <div class="panel-footer" id="newPanelFooter">
        <button type="button" class="panel-cancel-btn" id="newPanelCancelBtn">
            Cancelar
        </button>
        <button type="button" class="panel-save-btn" id="newPanelCreateBtn">
            <span class="save-text">
                <i class="fas fa-check me-1"></i>
                Crear Reserva
            </span>
            <span class="save-loading" style="display: none;">
                <span class="spinner-border spinner-border-sm" role="status"></span>
                Creando...
            </span>
        </button>
    </div>
</div>

<!-- Hidden form for CSRF token -->
<input type="hidden" id="newPanelCsrfToken" value="{{ csrf_token() }}">
