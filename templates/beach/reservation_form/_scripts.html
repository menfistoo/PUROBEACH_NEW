{% block extra_css %}
<style>
.reservation-steps{background:var(--color-white);border-radius:var(--border-radius-lg);padding:20px 40px;box-shadow:var(--shadow-sm)}
.step-container{display:flex;align-items:center;justify-content:center}
.step{display:flex;flex-direction:column;align-items:center;gap:8px}
.step-number{width:40px;height:40px;border-radius:50%;background:var(--color-light-gray);color:var(--color-medium-gray);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;transition:all .3s}
.step.active .step-number,.step.completed .step-number{background:linear-gradient(135deg,var(--color-primary) 0%,var(--color-primary-dark) 100%);color:#fff;box-shadow:0 4px 12px rgba(212,175,55,.4)}
.step.completed .step-number{background:var(--color-success)}
.step-label{font-size:13px;font-weight:600;color:var(--color-medium-gray)}
.step.active .step-label,.step.completed .step-label{color:var(--color-secondary)}
.step-line{width:100px;height:3px;background:var(--color-light-gray);margin:0 20px;margin-bottom:28px;border-radius:2px}
.reservation-card{border:none;border-radius:var(--border-radius-lg);overflow:hidden;box-shadow:var(--shadow-md)}
.reservation-card .card-header{padding:20px 24px;border-bottom:none;display:flex;justify-content:space-between;align-items:center}
.card-header-primary{background:linear-gradient(135deg,var(--color-secondary) 0%,var(--color-secondary-light,#2A5A8C) 100%);color:var(--color-surface)}
.card-header-gold{background:linear-gradient(135deg,var(--color-primary) 0%,var(--color-primary-dark) 100%);color:#fff}
.card-header-gold h5{color:#fff}
.step-icon{width:44px;height:44px;background:rgba(255,255,255,.2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px}
.reservation-card .card-body{padding:24px}
.search-input-wrapper{position:relative}
.search-icon{position:absolute;left:16px;top:50%;transform:translateY(-50%);color:var(--color-medium-gray);font-size:18px;z-index:2}
.search-input-wrapper .form-control{padding-left:48px;padding-right:48px;border-radius:var(--border-radius-lg);border:2px solid var(--color-border);transition:border-color .2s,box-shadow .2s}
.search-input-wrapper .form-control:focus{border-color:var(--color-primary);box-shadow:0 0 0 4px rgba(212,175,55,.15)}
.search-loading{position:absolute;right:16px;top:50%;transform:translateY(-50%);color:var(--color-primary)}
.search-results-container{margin-top:12px;background:var(--color-surface);border:1px solid var(--color-border);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-lg);max-height:400px;overflow-y:auto}
.results-section{border-bottom:1px solid var(--color-border)}
.results-section:last-of-type{border-bottom:none}
.results-header{padding:12px 16px;background:var(--color-off-white);font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--color-text-muted);display:flex;align-items:center;gap:8px}
.result-item{padding:14px 16px;border-bottom:1px solid var(--color-border);cursor:pointer;transition:background .2s;display:flex;align-items:center;gap:12px}
.result-item:last-child{border-bottom:none}
.result-item:hover{background:var(--color-accent)}
.result-avatar{width:40px;height:40px;border-radius:50%;background:var(--color-light-gray);display:flex;align-items:center;justify-content:center;color:var(--color-medium-gray);flex-shrink:0}
.result-avatar.hotel{background:var(--color-info-light,#e3f2fd);color:var(--color-info,#1976d2)}
.result-avatar.vip{background:var(--color-warning-light,#fff8e1);color:var(--color-warning)}
.result-info{flex:1;min-width:0}
.result-name{font-weight:600;color:var(--color-text);display:flex;align-items:center;gap:8px}
.result-details{font-size:13px;color:var(--color-text-muted);margin-top:2px}
.result-action{color:var(--color-primary);font-size:14px}
.no-results-section{padding:20px;text-align:center}
.no-results-message{color:var(--color-text-muted);display:flex;align-items:center;justify-content:center;gap:8px}
.create-customer-option{padding:16px;border-top:1px solid var(--color-border)}
.divider-line{text-align:center;position:relative;margin-bottom:12px}
.divider-line::before{content:'';position:absolute;left:0;top:50%;width:100%;height:1px;background:var(--color-border)}
.divider-line span{background:var(--color-surface);padding:0 12px;position:relative;color:var(--color-text-muted);font-size:12px}
.create-customer-form{background:linear-gradient(135deg,var(--color-background) 0%,var(--color-surface) 100%);border:2px solid var(--color-primary);border-radius:var(--border-radius-lg);padding:20px;margin-top:16px}
.create-customer-form .form-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--color-border)}
.create-customer-form .form-header h6{margin:0;color:var(--color-secondary)}
.form-actions{display:flex;justify-content:flex-end;gap:12px}
.phone-input-group{display:flex;gap:8px}
.country-select{width:110px;flex-shrink:0}
.phone-input-small .country-select{width:95px}
.preferences-inline{display:flex;flex-wrap:wrap;gap:8px}
.preference-chip-inline{cursor:pointer}
.preference-chip-inline input{display:none}
.preference-chip-inline .chip-content{display:inline-flex;align-items:center;gap:4px;padding:6px 12px;background:var(--color-off-white);border:1px solid var(--color-border);border-radius:var(--border-radius-full);font-size:12px;transition:all .2s}
.preference-chip-inline input:checked+.chip-content{background:var(--color-primary);border-color:var(--color-primary);color:#fff}
.selected-customer-card{background:linear-gradient(135deg,var(--color-background) 0%,var(--color-surface) 100%);border:2px solid var(--color-success);border-radius:var(--border-radius-lg);padding:20px}
.customer-header{display:flex;align-items:center;gap:16px}
.customer-avatar{width:56px;height:56px;background:linear-gradient(135deg,var(--color-primary) 0%,var(--color-primary-dark) 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:24px;flex-shrink:0}
.customer-avatar.hotel{background:linear-gradient(135deg,var(--color-info,#1976d2) 0%,var(--color-info-dark,#1565c0) 100%)}
.customer-main-info{flex:1;min-width:0}
.customer-main-info h4{font-size:18px;margin:0}
.customer-subtitle{color:var(--color-text-secondary);font-size:14px}
.hotel-info-section{margin-top:16px;padding-top:16px;border-top:1px solid var(--color-border)}
.info-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:var(--color-accent);border-radius:var(--border-radius-full);font-size:13px;color:var(--color-text-secondary)}
.info-badge i{color:var(--color-primary)}
.guest-selector-section{background:var(--color-accent);border-radius:var(--border-radius-md);padding:12px 16px;margin-top:16px}
.customer-additional-fields{padding-top:16px;border-top:1px solid var(--color-border)}
.customer-prefs-notes{padding-top:12px;border-top:1px solid var(--color-border)}
.notes-display{background:var(--color-warning-light,#fff8e1);padding:10px 14px;border-radius:var(--border-radius-md);font-size:14px;display:flex;align-items:flex-start;gap:10px}
.prefs-display{margin-top:12px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.prefs-label{font-size:13px;color:var(--color-text-muted)}
.history-section{padding-top:12px;border-top:1px solid var(--color-border)}
.history-header{display:flex;justify-content:space-between;align-items:center;font-size:14px}
.history-list{margin-top:12px;padding:12px;background:var(--color-off-white);border-radius:var(--border-radius-md)}
.history-item{color:var(--color-text);padding:6px 8px;border-radius:var(--border-radius-sm);transition:background .2s}
.history-item:hover{background:var(--color-accent);color:var(--color-primary)}
.empty-state{text-align:center;padding:48px 24px;background:var(--color-off-white);border-radius:var(--border-radius-lg);border:2px dashed var(--color-border)}
.empty-icon{width:80px;height:80px;background:var(--color-accent);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:32px;color:var(--color-primary)}
.booking-basics{background:var(--color-accent);border-radius:var(--border-radius-lg);padding:20px}
.furniture-selection{border:1px solid var(--color-border);border-radius:var(--border-radius-lg);overflow:hidden}
.furniture-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:var(--color-off-white);border-bottom:1px solid var(--color-border)}
.furniture-filters{display:flex;gap:8px}
.furniture-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:10px;padding:20px;min-height:200px;max-height:350px;overflow-y:auto;background:var(--color-surface)}
.furniture-alerts{padding:0 15px}.furniture-alerts .alert{margin-bottom:8px;padding:10px 15px;font-size:0.9rem;display:flex;align-items:center;gap:10px}.furniture-alerts .alert i{font-size:1.1rem}.furniture-alerts .alert-dismissible .btn-close{padding:12px}
.suggestion-modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1050}.suggestion-content{background:var(--color-surface);border-radius:12px;max-width:500px;width:90%;max-height:80vh;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.2)}
.suggestion-header{padding:15px 20px;background:linear-gradient(135deg,var(--color-primary),var(--color-primary-dark));color:var(--color-surface);display:flex;justify-content:space-between;align-items:center}.suggestion-header h5{margin:0}.suggestion-header .btn-close{filter:brightness(0) invert(1)}
.suggestion-list{max-height:400px;overflow-y:auto;padding:15px}.suggestion-item{padding:12px 15px;border:2px solid var(--color-border);border-radius:8px;margin-bottom:10px;cursor:pointer;transition:all 0.2s}.suggestion-item:hover{border-color:var(--color-primary);background:var(--color-primary-light-bg,#fffbf0)}
.suggestion-item.selected{border-color:var(--color-primary);background:var(--color-primary-light-bg,#fff8e6)}.suggestion-score{font-size:1.2rem;font-weight:600;color:var(--color-primary)}.suggestion-furniture{font-weight:500}.suggestion-reasons{font-size:0.85rem;color:var(--color-text-muted);margin-top:5px}
.date-picker-container{position:relative}
.date-picker-collapsed{display:flex;justify-content:space-between;align-items:center;padding:12px 15px;background:var(--color-surface);border:1px solid var(--color-border);border-radius:8px;cursor:pointer;transition:all 0.2s}
.date-picker-collapsed:hover{border-color:var(--color-primary);background:var(--color-primary-light-bg,#fffbf0)}
.selected-dates-preview{display:flex;align-items:center;font-size:0.95rem}
.calendar-expanded{position:absolute;top:100%;left:0;right:0;z-index:100;margin-top:5px;background:var(--color-surface);border:1px solid var(--color-border);border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.15);padding:15px}
.calendar-footer{border-top:1px solid var(--color-border);margin-top:10px;padding-top:10px;text-align:center}
.multi-calendar{background:var(--color-surface);user-select:none}
.cal-header{display:flex;justify-content:space-between;align-items:center;padding:8px 5px;margin-bottom:10px}
.cal-header .cal-title{font-weight:600;font-size:0.95rem}
.cal-header button{background:none;border:none;padding:5px 10px;cursor:pointer;border-radius:4px}.cal-header button:hover{background:var(--color-light-gray)}.cal-header button:focus{outline:2px solid var(--color-primary);outline-offset:2px}
.cal-weekdays{display:grid;grid-template-columns:repeat(7,1fr);text-align:center;font-size:0.75rem;font-weight:600;color:var(--color-text-muted);margin-bottom:5px}
.cal-days{display:grid;grid-template-columns:repeat(7,1fr);gap:3px}
.cal-day{aspect-ratio:1;display:flex;align-items:center;justify-content:center;font-size:0.85rem;border-radius:6px;cursor:pointer;transition:all 0.15s;border:none;background:transparent}
.cal-day:hover:not(.disabled):not(.selected){background:var(--color-light-gray)}
.cal-day:focus{outline:2px solid var(--color-primary);outline-offset:2px}
.cal-day.today{font-weight:700;color:var(--color-primary)}
.cal-day.selected{background:var(--color-primary);color:var(--color-surface);font-weight:600}
.cal-day.disabled{color:#767676;cursor:not-allowed}
.cal-day.other-month{color:#767676}
.selected-dates-tags{display:flex;flex-wrap:wrap;gap:5px}
.selected-dates-tags .date-tag{background:var(--color-light-gray);padding:2px 8px;border-radius:4px;font-size:0.8rem;display:inline-flex;align-items:center;gap:5px}
.selected-dates-tags .date-tag .remove{cursor:pointer;color:var(--color-error);font-weight:bold}
.furniture-placeholder{grid-column:1/-1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;color:var(--color-medium-gray)}
.furniture-item{aspect-ratio:1;border-radius:var(--border-radius-md);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;border:2px solid transparent;background:var(--color-off-white)}
.furniture-item:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}
.furniture-item.available{background:var(--color-accent);border-color:var(--color-primary)}
.furniture-item.selected{background:linear-gradient(135deg,var(--color-primary) 0%,var(--color-primary-dark) 100%);border-color:var(--color-primary-dark);color:#fff}
.furniture-item.selected .furniture-type{color:rgba(255,255,255,.8)}
.furniture-item.occupied{background:var(--color-light-gray);border-color:var(--color-medium-gray);cursor:not-allowed;opacity:.6}
.furniture-number{font-weight:700;font-size:16px}
.furniture-type{font-size:11px;color:var(--color-text-muted);margin-top:2px}
.furniture-capacity{font-size:10px;color:var(--color-text-muted);margin-top:4px}
.furniture-summary{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:var(--color-off-white);border-top:1px solid var(--color-border)}
.summary-item{font-size:14px}
.summary-label{color:var(--color-text-muted)}
.summary-value{font-weight:700;color:var(--color-primary);margin-left:8px}
.summary-legend{display:flex;gap:16px;font-size:12px}
.legend-item{display:flex;align-items:center;gap:6px;color:var(--color-text-muted)}
.legend-item .dot{width:12px;height:12px;border-radius:3px}
.dot.available{background:var(--color-accent);border:1px solid var(--color-primary)}
.dot.selected{background:var(--color-primary)}
.dot.occupied{background:var(--color-medium-gray)}
.section-title{font-size:14px;font-weight:600;color:var(--color-secondary);margin-bottom:12px;display:flex;align-items:center}
.payment-section{background:var(--color-off-white);border-radius:var(--border-radius-lg);padding:20px}
.preferences-grid{display:flex;flex-wrap:wrap;gap:10px}
.preference-chip{cursor:pointer}
.preference-chip input{display:none}
.chip-content{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;background:var(--color-off-white);border:2px solid var(--color-border);border-radius:var(--border-radius-full);font-size:13px;transition:all .2s}
.preference-chip input:checked+.chip-content{background:var(--color-primary);border-color:var(--color-primary);color:#fff}
.chip-content:hover{border-color:var(--color-primary)}
.reservation-summary-card{border:none;border-radius:var(--border-radius-lg);box-shadow:var(--shadow-lg);border-top:4px solid var(--color-primary)}
.reservation-summary-card .card-header{background:transparent;padding:20px 24px 16px;border-bottom:1px solid var(--color-border)}
.reservation-summary-card .card-body{padding:24px}
.summary-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0}
.summary-row .summary-label{color:var(--color-text-muted);font-size:14px}
.summary-row .summary-value{font-weight:600;color:var(--color-text);margin-left:0}
.furniture-list{display:flex;flex-wrap:wrap;gap:6px}
.furniture-tag{background:var(--color-accent);padding:4px 10px;border-radius:var(--border-radius-full);font-size:12px;font-weight:500}
@media(max-width:768px){.step-line{width:40px;margin:0 10px}.furniture-header{flex-direction:column;gap:12px}.furniture-filters{width:100%;flex-wrap:wrap}.furniture-grid{grid-template-columns:repeat(auto-fill,minmax(70px,1fr))}.customer-header{flex-wrap:wrap}}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded',function(){
const form=document.getElementById('reservationForm'),
    customerSearch=document.getElementById('customerSearch'),
    searchResults=document.getElementById('searchResults'),
    customerId=document.getElementById('customerId'),
    hotelGuestId=document.getElementById('hotelGuestId'),
    selectedCustomer=document.getElementById('selectedCustomer'),
    emptyState=document.getElementById('emptyState'),
    createCustomerForm=document.getElementById('createCustomerForm'),
    reservationDate=document.getElementById('reservationDate'),
    furnitureGrid=document.getElementById('furnitureGrid'),
    chargeToRoom=document.getElementById('chargeToRoom'),
    chargeRefContainer=document.getElementById('chargeRefContainer'),
    csrfToken='{{ csrf_token() }}';
let selectedFurniture=new Set,furnitureData=[],currentCustomerData=null,roomGuestsData=[],lastSearchQuery='',searchResultsCache=[];
const languageNames={'ES':'Espanol','EN':'Ingles','DE':'Aleman','FR':'Frances','IT':'Italiano','PT':'Portugues','NL':'Holandes','RU':'Ruso'},
    nationalityToLanguage={'DE':'DE','AT':'DE','CH':'DE','GB':'EN','US':'EN','AU':'EN','UK':'EN','ES':'ES','MX':'ES','AR':'ES','FR':'FR','IT':'IT','PT':'PT','BR':'PT','NL':'NL','RU':'RU'};

function formatDate(d){if(!d)return'-';try{return new Date(d).toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit'})}catch{return d}}

function hasCustomerSelected(){return customerId.value || hotelGuestId.value}

function updateStepIndicators(){
    const s1=document.getElementById('step1Indicator'),s2=document.getElementById('step2Indicator'),s3=document.getElementById('step3Indicator');
    hasCustomerSelected()?(s1.classList.add('completed'),s2.classList.add('active')):(s1.classList.remove('completed'),s2.classList.remove('active'));
    selectedFurniture.size>0?s3.classList.add('active'):s3.classList.remove('active');
}

function updateSummary(){
    const sc=document.getElementById('summaryCustomer');
    currentCustomerData?sc.textContent=currentCustomerData.display_name||currentCustomerData.guest_name||`${currentCustomerData.first_name||''} ${currentCustomerData.last_name||''}`.trim()||'No seleccionado':sc.textContent='No seleccionado';
    document.getElementById('summaryDate').textContent=reservationDate.value?formatDate(reservationDate.value):'-';
    document.getElementById('summaryPeople').textContent=document.getElementById('numPeople').value||'2';
    document.getElementById('summaryFurniture').textContent=`${selectedFurniture.size} items`;
    const sfl=document.getElementById('summaryFurnitureList');
    sfl.innerHTML=selectedFurniture.size>0?furnitureData.filter(f=>selectedFurniture.has(f.id)).map(f=>`<span class="furniture-tag">${f.number}</span>`).join(''):'';
    updateStepIndicators();
}

{% if mode == 'create' %}
let searchTimeout;
customerSearch&&customerSearch.addEventListener('input',function(){
    clearTimeout(searchTimeout);
    const q=this.value.trim();
    lastSearchQuery=q;
    if(q.length<2){searchResults.style.display='none';return}
    document.getElementById('searchLoading').style.display='block';
    searchTimeout=setTimeout(()=>{
        fetch(`{{ url_for('beach.api.customers_search') }}?q=${encodeURIComponent(q)}`).then(r=>r.json()).then(d=>{
            document.getElementById('searchLoading').style.display='none';
            searchResultsCache=d.customers||[];
            displaySearchResults(searchResultsCache,q);
        }).catch(()=>{document.getElementById('searchLoading').style.display='none'})
    },300);
});

function displaySearchResults(customers,query){
    const bcs=document.getElementById('beachClubResults'),hs=document.getElementById('hotelGuestsResults'),
          nrs=document.getElementById('noResultsSection'),bcl=document.getElementById('beachClubList'),hgl=document.getElementById('hotelGuestsList'),
          bc=customers.filter(c=>c.source==='customer'),hg=customers.filter(c=>c.source==='hotel_guest');
    bcl.innerHTML='';hgl.innerHTML='';
    if(bc.length>0){
        bcs.style.display='block';
        bc.forEach(c=>{
            const vip=c.vip_status||c.vip_code;
            bcl.innerHTML+=`<div class="result-item" data-id="${c.id}" data-source="customer"><div class="result-avatar ${vip?'vip':''}"><i class="fas ${vip?'fa-star':'fa-user'}"></i></div><div class="result-info"><div class="result-name">${c.display_name||c.first_name+' '+(c.last_name||'')} ${vip?'<span class="badge bg-warning text-dark">VIP</span>':''}</div><div class="result-details">${c.customer_type==='interno'?'<i class="fas fa-door-open"></i> Hab. '+(c.room_number||'-'):'<i class="fas fa-user"></i> Externo'}${c.phone?' - '+c.phone:''}</div></div><div class="result-action"><i class="fas fa-chevron-right"></i></div></div>`;
        });
    }else bcs.style.display='none';
    if(hg.length>0){
        hs.style.display='block';
        hg.forEach(g=>{
            const vip=g.vip_code;
            const checkinBadge=g.is_checkin_today?'<span class="badge bg-success">Check-in</span>':'';
            const checkoutBadge=g.is_checkout_today?'<span class="badge bg-danger">Check-out</span>':'';
            hgl.innerHTML+=`<div class="result-item" data-id="${g.id}" data-source="hotel_guest"><div class="result-avatar hotel"><i class="fas fa-hotel"></i></div><div class="result-info"><div class="result-name">${g.guest_name} ${g.is_main_guest?'<span class="badge bg-primary">Principal</span>':''} ${vip?'<span class="badge bg-warning text-dark">VIP</span>':''} ${checkinBadge} ${checkoutBadge}</div><div class="result-details"><i class="fas fa-door-open"></i> Hab. ${g.room_number} - <i class="fas fa-calendar"></i> ${formatDate(g.arrival_date)} - ${formatDate(g.departure_date)}${g.booking_reference?' - #'+g.booking_reference:''}</div></div><div class="result-action"><i class="fas fa-chevron-right"></i></div></div>`;
        });
    }else hs.style.display='none';
    if(bc.length===0&&hg.length===0){nrs.style.display='block';document.getElementById('searchQueryDisplay').textContent=query}else nrs.style.display='none';
    searchResults.style.display='block';
}

searchResults&&searchResults.addEventListener('click',function(e){
    const item=e.target.closest('.result-item');
    if(!item)return;
    const id=parseInt(item.dataset.id),source=item.dataset.source;
    if(source==='hotel_guest'){
        // Find guest in cache - DON'T create customer yet
        const guest=searchResultsCache.find(x=>x.id===id&&x.source==='hotel_guest');
        if(guest){
            // Load room guests for selector
            fetch(`{{ url_for('beach.api.hotel_guest_lookup') }}?room=${encodeURIComponent(guest.room_number)}`).then(r=>r.json()).then(gd=>{
                roomGuestsData=gd.guests||[];
                selectHotelGuest(guest,gd.guest_count);
            }).catch(()=>selectHotelGuest(guest,1));
        }
    }else{
        const c=searchResultsCache.find(x=>x.id===id&&x.source==='customer');
        if(c)selectCustomer(c);
    }
});

function selectHotelGuest(g,guestCount){
    // Store hotel_guest_id, NOT customer_id - customer will be created on reservation submit
    currentCustomerData={...g,source:'hotel_guest',room_guest_count:guestCount};
    customerId.value='';
    hotelGuestId.value=g.id;
    customerSearch.value='';
    searchResults.style.display='none';
    createCustomerForm.style.display='none';
    emptyState.style.display='none';
    selectedCustomer.style.display='block';

    const dn=g.guest_name||g.display_name;
    document.getElementById('customerName').textContent=dn;
    const av=document.getElementById('customerAvatar');
    av.classList.add('hotel');av.innerHTML='<i class="fas fa-hotel"></i>';
    document.getElementById('customerVipBadge').style.display=g.vip_code?'inline':'none';
    const tb=document.getElementById('customerTypeBadge');
    tb.className='badge bg-info';tb.textContent='Huesped Hotel';
    const ri=document.getElementById('customerRoomInfo');
    document.getElementById('customerRoom').textContent=`Hab. ${g.room_number}`;ri.style.display='inline';

    const his=document.getElementById('hotelInfoSection');
    document.getElementById('customerArrival').textContent=formatDate(g.arrival_date);
    document.getElementById('customerDeparture').textContent=formatDate(g.departure_date);
    his.style.display='block';
    const brb=document.getElementById('bookingRefBadge');
    if(g.booking_reference){document.getElementById('customerBookingRef').textContent='#'+g.booking_reference;brb.style.display='block'}else brb.style.display='none';
    const lb=document.getElementById('languageBadge');
    const lc=nationalityToLanguage[g.nationality?.toUpperCase()];
    if(lc){document.getElementById('customerLanguage').textContent=languageNames[lc]||lc;lb.style.display='block'}else lb.style.display='none';

    const gss=document.getElementById('guestSelectorSection');
    if(guestCount>1&&roomGuestsData.length>1){
        document.getElementById('guestCount').textContent=guestCount;
        const gs=document.getElementById('guestSelector');
        gs.innerHTML=roomGuestsData.map(x=>`<option value="${x.id}" ${x.id===g.id?'selected':''}>${x.guest_name} ${x.is_main_guest?'(Principal)':''}</option>`).join('');
        gss.style.display='block';
        document.getElementById('numPeople').value=guestCount;
    }else gss.style.display='none';

    document.getElementById('customerPhone').value=g.phone||'';
    document.getElementById('customerEmail').value=g.email||'';

    // Show hotel guest notes if they exist
    if(g.notes){
        document.getElementById('customerNotesText').textContent=g.notes;
        document.getElementById('customerNotesDisplay').style.display='block';
        document.getElementById('customerPrefsNotesSection').style.display='block';
    }else{
        document.getElementById('customerNotesDisplay').style.display='none';
        document.getElementById('customerPrefsNotesSection').style.display='none';
    }
    document.getElementById('customerPrefsDisplay').style.display='none'; // Hotel guests have no preferences yet
    document.getElementById('customerHistorySection').style.display='none';

    // Hide profile button and stats for hotel guests (they don't have a customer record yet)
    document.getElementById('viewCustomerProfileBtn').style.display='none';
    document.getElementById('customerStatsSection').style.display='none';

    if(chargeToRoom){chargeToRoom.checked=true;chargeRefContainer.style.display='block';document.getElementById('chargeReference').value=`Hab. ${g.room_number}`}
    updateSummary();
    checkDuplicateReservation(); // Phase 6B: Check for existing reservations
}

function selectCustomer(c){
    if(!c||!c.id)return;
    currentCustomerData=c;
    customerId.value=c.id;
    hotelGuestId.value='';
    customerSearch.value='';
    searchResults.style.display='none';
    createCustomerForm.style.display='none';
    emptyState.style.display='none';
    selectedCustomer.style.display='block';

    const dn=c.display_name||c.guest_name||`${c.first_name||''} ${c.last_name||''}`.trim();
    document.getElementById('customerName').textContent=dn;
    const av=document.getElementById('customerAvatar');
    if(c.customer_type==='interno'){av.classList.add('hotel');av.innerHTML='<i class="fas fa-hotel"></i>'}
    else{av.classList.remove('hotel');av.innerHTML='<i class="fas fa-user"></i>'}
    document.getElementById('customerVipBadge').style.display=(c.vip_status||c.vip_code)?'inline':'none';
    const tb=document.getElementById('customerTypeBadge');
    if(c.customer_type==='interno'){tb.className='badge bg-info';tb.textContent='Huesped Hotel'}
    else{tb.className='badge bg-success';tb.textContent='Cliente Externo'}
    const ri=document.getElementById('customerRoomInfo');
    if(c.room_number&&c.room_number!=='None'&&c.room_number!=='null'){document.getElementById('customerRoom').textContent=`Hab. ${c.room_number}`;ri.style.display='inline'}else ri.style.display='none';

    const his=document.getElementById('hotelInfoSection');
    if(c.arrival_date||c.departure_date){
        document.getElementById('customerArrival').textContent=formatDate(c.arrival_date);
        document.getElementById('customerDeparture').textContent=formatDate(c.departure_date);
        his.style.display='block';
        const brb=document.getElementById('bookingRefBadge');
        if(c.booking_reference){document.getElementById('customerBookingRef').textContent='#'+c.booking_reference;brb.style.display='block'}else brb.style.display='none';
        const lb=document.getElementById('languageBadge');
        const lc=c.language||nationalityToLanguage[c.nationality?.toUpperCase()];
        if(lc){document.getElementById('customerLanguage').textContent=languageNames[lc]||lc;lb.style.display='block'}else lb.style.display='none';
    }else his.style.display='none';

    document.getElementById('guestSelectorSection').style.display='none';
    if(c.phone)document.getElementById('customerPhone').value=c.phone;
    if(c.email)document.getElementById('customerEmail').value=c.email;
    if(c.country_code)document.getElementById('customerCountryCode').value=c.country_code;

    // Show profile link for beach customers
    const profileBtn=document.getElementById('viewCustomerProfileBtn');
    profileBtn.href=`{{ url_for('beach.customers_detail', customer_id=0) }}`.replace('0',c.id);
    profileBtn.style.display='inline-block';

    // Show customer stats section
    const statsSection=document.getElementById('customerStatsSection');
    let hasStats=false;

    // Language (for customers without hotel info showing)
    const langBadge=document.getElementById('customerLanguageBadge');
    if(!his.style.display||his.style.display==='none'){
        const lang=c.language||nationalityToLanguage[(c.nationality||'').toUpperCase()];
        if(lang){
            document.getElementById('customerLanguageText').textContent=languageNames[lang]||lang;
            langBadge.style.display='block';hasStats=true;
        }else langBadge.style.display='none';
    }else langBadge.style.display='none';

    // Total visits
    const visitsBadge=document.getElementById('customerVisitsBadge');
    if(c.total_visits>0){
        document.getElementById('customerTotalVisits').textContent=c.total_visits;
        visitsBadge.style.display='block';hasStats=true;
    }else visitsBadge.style.display='none';

    // Total spent
    const spentBadge=document.getElementById('customerSpentBadge');
    if(c.total_spent>0){
        document.getElementById('customerTotalSpent').textContent=parseFloat(c.total_spent).toFixed(2);
        spentBadge.style.display='block';hasStats=true;
    }else spentBadge.style.display='none';

    statsSection.style.display=hasStats?'block':'none';

    const pns=document.getElementById('customerPrefsNotesSection');
    let hc=false;
    if(c.notes){document.getElementById('customerNotesText').textContent=c.notes;document.getElementById('customerNotesDisplay').style.display='flex';hc=true}
    else document.getElementById('customerNotesDisplay').style.display='none';
    if(c.preferences&&c.preferences.length>0){
        const bgs=c.preferences.map(code=>{
            const cb=document.querySelector(`.preference-check[value="${code}"]`);
            if(cb){cb.checked=true;const ch=cb.parentElement.querySelector('.chip-content');return`<span class="badge bg-primary me-1">${ch?.textContent?.trim()||code}</span>`}return'';
        }).join('');
        document.getElementById('customerPrefsBadges').innerHTML=bgs;
        document.getElementById('customerPrefsDisplay').style.display='flex';hc=true;
    }else document.getElementById('customerPrefsDisplay').style.display='none';
    pns.style.display=hc?'block':'none';

    if(chargeToRoom&&c.customer_type==='interno'){chargeToRoom.checked=true;chargeRefContainer.style.display='block';document.getElementById('chargeReference').value=`Hab. ${c.room_number}`}
    loadCustomerHistory(c.id);
    updateSummary();
    checkDuplicateReservation(); // Phase 6B: Check for existing reservations
}

function loadCustomerHistory(cid){
    const hs=document.getElementById('customerHistorySection'),hl=document.getElementById('customerHistoryList');
    fetch(`/beach/api/customers/${cid}/history`).then(r=>r.json()).then(d=>{
        const h=d.history||[];
        if(h.length>0){
            document.getElementById('customerVisitsCount').textContent=h.length;
            hl.innerHTML=h.slice(0,5).map(x=>`<a href="/beach/reservations/${x.id}" class="history-item d-block small mb-1 text-decoration-none" target="_blank"><strong>${formatDate(x.date)}</strong> - ${x.furniture_numbers||'Sin mobiliario'} <span class="text-muted">(${x.furniture_types||'-'})</span> <i class="fas fa-external-link-alt text-primary ms-1 small"></i></a>`).join('');
            hs.style.display='block';
        }else hs.style.display='none';
    }).catch(()=>{hs.style.display='none'});
}

document.getElementById('toggleHistoryBtn')?.addEventListener('click',function(){
    const l=document.getElementById('customerHistoryList'),h=l.style.display==='none';
    l.style.display=h?'block':'none';
    this.innerHTML=h?'Ocultar <i class="fas fa-chevron-up"></i>':'Ver <i class="fas fa-chevron-down"></i>';
});

document.getElementById('guestSelector')?.addEventListener('change',function(){
    const gid=parseInt(this.value),g=roomGuestsData.find(x=>x.id===gid);
    if(g)selectHotelGuest(g,roomGuestsData.length);
});

document.getElementById('clearCustomerBtn')?.addEventListener('click',function(){
    customerId.value='';
    hotelGuestId.value='';
    currentCustomerData=null;
    roomGuestsData=[];
    selectedCustomer.style.display='none';
    emptyState.style.display='block';
    customerSearch.value='';
    document.querySelectorAll('.preference-check').forEach(cb=>cb.checked=false);
    if(chargeToRoom){chargeToRoom.checked=false;chargeRefContainer.style.display='none'}
    document.getElementById('viewCustomerProfileBtn').style.display='none';
    document.getElementById('customerStatsSection').style.display='none';
    updateSummary();
});

document.getElementById('showCreateFormBtn')?.addEventListener('click',function(){
    searchResults.style.display='none';
    createCustomerForm.style.display='block';
    emptyState.style.display='none';
    if(lastSearchQuery&&!/^\d+$/.test(lastSearchQuery)){
        const p=lastSearchQuery.split(' ');
        document.getElementById('newFirstName').value=p[0]||'';
        document.getElementById('newLastName').value=p.slice(1).join(' ')||'';
    }
});

document.getElementById('cancelCreateBtn')?.addEventListener('click',hideCreateForm);
document.getElementById('cancelCreate2Btn')?.addEventListener('click',hideCreateForm);
function hideCreateForm(){createCustomerForm.style.display='none';emptyState.style.display='block';customerSearch.value=''}

document.getElementById('saveNewCustomerBtn')?.addEventListener('click',function(){
    const fn=document.getElementById('newFirstName').value.trim(),ln=document.getElementById('newLastName').value.trim(),
          cc=document.getElementById('newCountryCode').value,ph=document.getElementById('newPhone').value.trim(),
          em=document.getElementById('newEmail').value.trim(),lg=document.getElementById('newLanguage').value,
          nt=document.getElementById('newNotes').value.trim(),err=document.getElementById('createCustomerError');
    if(!fn){err.textContent='El nombre es requerido';err.style.display='block';return}
    if(!ph&&!em){err.textContent='Se requiere telefono o email';err.style.display='block';return}
    err.style.display='none';this.disabled=true;
    const prefs=[];document.querySelectorAll('.new-customer-pref:checked').forEach(cb=>prefs.push(cb.value));
    fetch('{{ url_for("beach.api.customers_create") }}',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},body:JSON.stringify({customer_type:'externo',first_name:fn,last_name:ln,phone:ph,email:em,country_code:cc,language:lg,notes:nt,preferences:prefs})})
    .then(r=>r.json()).then(d=>{
        this.disabled=false;
        if(d.success){createCustomerForm.style.display='none';selectCustomer(d.customer)}
        else{err.textContent=d.error||'Error al crear cliente';err.style.display='block'}
    }).catch(()=>{this.disabled=false;err.textContent='Error de conexion';err.style.display='block'});
});
{% endif %}

reservationDate.addEventListener('change',function(){loadFurnitureAvailability();updateSummary()});

function loadFurnitureAvailability(){
    const dv=reservationDate.value;if(!dv)return;
    const zf=document.getElementById('furnitureZoneFilter'),tf=document.getElementById('furnitureTypeFilter'),params=new URLSearchParams({date:dv});
    if(zf.value)params.append('zone_id',zf.value);
    if(tf.value)params.append('type',tf.value);
    furnitureGrid.innerHTML='<div class="furniture-placeholder"><i class="fas fa-spinner fa-spin fa-2x mb-2"></i><p class="mb-0">Cargando disponibilidad...</p></div>';
    fetch(`{{ url_for('beach.api.available_furniture') }}?${params}`).then(r=>r.json()).then(d=>{furnitureData=d.furniture||[];renderFurnitureGrid()})
    .catch(()=>{furnitureGrid.innerHTML='<div class="furniture-placeholder text-danger"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p class="mb-0">Error al cargar mobiliario</p></div>'});
}

function renderFurnitureGrid(){
    if(furnitureData.length===0){furnitureGrid.innerHTML='<div class="furniture-placeholder"><i class="fas fa-umbrella-beach fa-2x mb-2"></i><p class="mb-0">No hay mobiliario disponible</p></div>';return}
    furnitureGrid.innerHTML=furnitureData.map(f=>`<div class="furniture-item ${selectedFurniture.has(f.id)?'selected':'available'}" data-id="${f.id}"><div class="furniture-number">${f.number}</div><div class="furniture-type">${f.type_name||f.furniture_type}</div><div class="furniture-capacity"><i class="fas fa-users"></i> ${f.capacity}</div></div>`).join('');
    document.getElementById('selectedCount').textContent=selectedFurniture.size;
    document.querySelectorAll('.furniture-item').forEach(item=>{
        item.addEventListener('click',function(){
            const id=parseInt(this.dataset.id);
            selectedFurniture.has(id)?selectedFurniture.delete(id):selectedFurniture.add(id);
            renderFurnitureGrid();updateSummary();
        });
    });
}

document.getElementById('refreshFurniture')?.addEventListener('click',loadFurnitureAvailability);
document.getElementById('furnitureZoneFilter')?.addEventListener('change',loadFurnitureAvailability);
document.getElementById('furnitureTypeFilter')?.addEventListener('change',loadFurnitureAvailability);
chargeToRoom?.addEventListener('change',function(){chargeRefContainer.style.display=this.checked?'block':'none'});
document.getElementById('numPeople')?.addEventListener('change',updateSummary);

// ============================================================================
// PHASE 6B: SMART FEATURES
// ============================================================================

const furnitureAlerts=document.getElementById('furnitureAlerts');

function showAlert(type,message,dismissible=true){
    const id='alert-'+Date.now();
    const alertHtml=`<div id="${id}" class="alert alert-${type} ${dismissible?'alert-dismissible':''} fade show" role="alert">
        <i class="fas fa-${type==='warning'?'exclamation-triangle':type==='danger'?'times-circle':type==='success'?'check-circle':'info-circle'}"></i>
        <span>${message}</span>
        ${dismissible?'<button type="button" class="btn-close" data-bs-dismiss="alert"></button>':''}
    </div>`;
    furnitureAlerts.insertAdjacentHTML('beforeend',alertHtml);
    return id;
}

function clearAlerts(type){
    if(type){furnitureAlerts.querySelectorAll(`.alert-${type}`).forEach(a=>a.remove())}
    else{furnitureAlerts.innerHTML=''}
}

// Check for duplicate reservation when customer + date selected
async function checkDuplicateReservation(){
    const cid=customerId.value||hotelGuestId.value;
    const dv=reservationDate.value;
    if(!cid||!dv)return;
    clearAlerts('warning');
    try{
        const resp=await fetch('{{ url_for("beach.api.check_duplicate") }}',{
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},
            body:JSON.stringify({customer_id:parseInt(cid),dates:[dv]})
        });
        const data=await resp.json();
        if(data.is_duplicate){
            showAlert('warning',`<strong>Reserva existente:</strong> Este cliente ya tiene reserva el ${data.existing_reservation.date} (Ticket: ${data.existing_reservation.ticket_number})`);
        }
    }catch(e){console.error('Error checking duplicate:',e)}
}

// Validate furniture contiguity when selection changes
async function validateContiguity(){
    if(selectedFurniture.size<2)return clearAlerts('info');
    clearAlerts('info');
    const dv=reservationDate.value;
    if(!dv)return;
    try{
        const resp=await fetch('{{ url_for("beach.api.validate_contiguity") }}',{
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},
            body:JSON.stringify({furniture_ids:Array.from(selectedFurniture),date:dv})
        });
        const data=await resp.json();
        if(!data.is_contiguous){
            showAlert('info',`<strong>Aviso:</strong> El mobiliario seleccionado no es contiguo (hay huecos ocupados entre ellos)`);
        }
    }catch(e){console.error('Error validating contiguity:',e)}
}

// Suggest furniture button handler
document.getElementById('suggestFurnitureBtn')?.addEventListener('click',async function(){
    const dv=reservationDate.value;
    if(!dv){alert('Seleccione una fecha primero');return}
    const numPeople=parseInt(document.getElementById('numPeople').value)||2;
    const cid=customerId.value||hotelGuestId.value;
    const zoneId=document.getElementById('furnitureZoneFilter').value;
    const prefs=[];document.querySelectorAll('.reservation-pref:checked').forEach(cb=>prefs.push(cb.value));

    this.disabled=true;this.innerHTML='<i class="fas fa-spinner fa-spin me-1"></i>Buscando...';
    try{
        const resp=await fetch('{{ url_for("beach.api.suggest_furniture") }}',{
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},
            body:JSON.stringify({dates:[dv],num_people:numPeople,preferences:prefs.join(','),customer_id:cid?parseInt(cid):null,zone_id:zoneId?parseInt(zoneId):null,limit:5})
        });
        const data=await resp.json();
        if(data.success&&data.suggestions?.length>0){
            showSuggestionModal(data.suggestions);
        }else{
            alert(data.error||'No se encontraron sugerencias');
        }
    }catch(e){console.error('Error getting suggestions:',e);alert('Error al obtener sugerencias')}
    finally{this.disabled=false;this.innerHTML='<i class="fas fa-magic me-1"></i>Sugerir'}
});

function showSuggestionModal(suggestions){
    const modal=document.createElement('div');
    modal.className='suggestion-modal';
    modal.id='suggestionModal';
    modal.innerHTML=`
        <div class="suggestion-content">
            <div class="suggestion-header">
                <h5><i class="fas fa-magic me-2"></i>Sugerencias de Mobiliario</h5>
                <button type="button" class="btn-close" onclick="closeSuggestionModal()" aria-label="Cerrar"></button>
            </div>
            <div class="suggestion-list">
                ${suggestions.map((s,i)=>`
                    <div class="suggestion-item" data-ids="${s.furniture_ids.join(',')}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="suggestion-furniture">${s.furniture_numbers.join(', ')}</div>
                                <div class="text-muted small">${s.zone_name||'Zona no especificada'} - Capacidad: ${s.total_capacity}</div>
                                ${s.reasons?.length?`<div class="suggestion-reasons"><i class="fas fa-check-circle text-success me-1"></i>${s.reasons.slice(0,2).join(' | ')}</div>`:''}
                            </div>
                            <div class="suggestion-score">${Math.round((s.scores?.total||0)*100)}%</div>
                        </div>
                    </div>
                `).join('')}
            </div>
            <div class="p-3 bg-light border-top">
                <small class="text-muted"><i class="fas fa-info-circle me-1"></i>Haz clic en una sugerencia para seleccionarla</small>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.addEventListener('click',function(e){
        const item=e.target.closest('.suggestion-item');
        if(item){
            const ids=item.dataset.ids.split(',').map(Number);
            selectedFurniture.clear();
            ids.forEach(id=>selectedFurniture.add(id));
            renderFurnitureGrid();
            updateSummary();
            closeSuggestionModal();
            showAlert('success','Mobiliario seleccionado automaticamente',true);
        }
        if(e.target===modal)closeSuggestionModal();
    });
}

window.closeSuggestionModal=function(){
    document.getElementById('suggestionModal')?.remove();
};

// Trigger duplicate check when date changes (if customer already selected)
reservationDate.addEventListener('change',function(){
    checkDuplicateReservation();
});

// ============================================================================
// DATE PICKER WITH MULTI-DAY SUPPORT
// ============================================================================

const datePickerCollapsed=document.getElementById('datePickerCollapsed');
const calendarExpanded=document.getElementById('calendarExpanded');
const multiCalendar=document.getElementById('multiCalendar');
const datesPreviewText=document.getElementById('datesPreviewText');
let selectedDates=new Set();
let calendarMonth=new Date().getMonth();
let calendarYear=new Date().getFullYear();
let calendarOpen=false;

const monthNames=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const dayNames=['Lu','Ma','Mi','Ju','Vi','Sa','Do'];

window.toggleCalendar=function(open){
    calendarOpen=open;
    if(open){
        calendarExpanded.style.display='block';
        datePickerCollapsed.querySelector('.fa-chevron-down').classList.replace('fa-chevron-down','fa-chevron-up');
        renderCalendar();
    }else{
        calendarExpanded.style.display='none';
        datePickerCollapsed.querySelector('.fa-chevron-up').classList.replace('fa-chevron-up','fa-chevron-down');
        updatePreviewText();
        // Update hidden input with first selected date
        const sorted=getSelectedDates();
        if(sorted.length>0){
            reservationDate.value=sorted[0];
            loadFurnitureAvailability();
        }
        updateSummary();
    }
};

function renderCalendar(){
    const today=new Date();today.setHours(0,0,0,0);
    const firstDay=new Date(calendarYear,calendarMonth,1);
    const lastDay=new Date(calendarYear,calendarMonth+1,0);
    let startDay=firstDay.getDay();startDay=startDay===0?6:startDay-1;

    let html=`
        <div class="cal-header">
            <button type="button" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
            <span class="cal-title">${monthNames[calendarMonth]} ${calendarYear}</span>
            <button type="button" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
        </div>
        <div class="cal-weekdays">${dayNames.map(d=>`<div>${d}</div>`).join('')}</div>
        <div class="cal-days">
    `;

    for(let i=0;i<startDay;i++){
        const prevMonth=new Date(calendarYear,calendarMonth,0-startDay+i+1);
        html+=`<div class="cal-day other-month disabled">${prevMonth.getDate()}</div>`;
    }

    for(let d=1;d<=lastDay.getDate();d++){
        const date=new Date(calendarYear,calendarMonth,d);
        const dateStr=date.toISOString().split('T')[0];
        const isToday=date.getTime()===today.getTime();
        const isPast=date<today;
        const isSelected=selectedDates.has(dateStr);

        let classes=['cal-day'];
        if(isToday)classes.push('today');
        if(isPast)classes.push('disabled');
        if(isSelected)classes.push('selected');

        html+=`<div class="${classes.join(' ')}" data-date="${dateStr}" onclick="toggleDate('${dateStr}',${isPast})">${d}</div>`;
    }

    html+=`</div>`;
    multiCalendar.innerHTML=html;
    updateSelectedDisplay();
}

let calendarInteracting=false;

window.changeMonth=function(delta){
    calendarInteracting=true;
    calendarMonth+=delta;
    if(calendarMonth>11){calendarMonth=0;calendarYear++}
    if(calendarMonth<0){calendarMonth=11;calendarYear--}
    renderCalendar();
    setTimeout(()=>{calendarInteracting=false},50);
};

window.toggleDate=function(dateStr,isPast){
    if(isPast)return;
    calendarInteracting=true;
    if(selectedDates.has(dateStr)){
        selectedDates.delete(dateStr);
    }else{
        selectedDates.add(dateStr);
    }
    renderCalendar();
    setTimeout(()=>{calendarInteracting=false},50);
};

window.removeDate=function(dateStr,e){
    if(e)e.stopPropagation();
    selectedDates.delete(dateStr);
    renderCalendar();
    updatePreviewText();
};

function updateSelectedDisplay(){
    const count=selectedDates.size;
    document.getElementById('selectedDatesCount').textContent=count;
    const list=document.getElementById('selectedDatesList');
    const sorted=Array.from(selectedDates).sort();
    list.innerHTML=sorted.map(d=>`<span class="date-tag">${formatDate(d)}<span class="remove" onclick="removeDate('${d}',event)">&times;</span></span>`).join('');
}

function updatePreviewText(){
    const sorted=getSelectedDates();
    const count=sorted.length;
    if(count===0){
        datesPreviewText.textContent='Seleccionar fechas...';
    }else if(count===1){
        datesPreviewText.textContent=formatDate(sorted[0]);
    }else{
        datesPreviewText.innerHTML=`<strong>${count} das:</strong> ${sorted.slice(0,3).map(formatDate).join(', ')}${count>3?' ...':''}`;
    }
    // Update summary
    if(count>0){
        document.getElementById('summaryDate').textContent=count===1?formatDate(sorted[0]):`${formatDate(sorted[0])} - ${formatDate(sorted[count-1])} (${count})`;
    }
}

function getSelectedDates(){
    return Array.from(selectedDates).sort();
}

function isMultiday(){
    return selectedDates.size>1;
}

// Initialize with existing date if in edit mode or pre-selected
{% if mode == 'edit' and reservation %}
selectedDates.add('{{ reservation.reservation_date }}');
updatePreviewText();
{% elif selected_date %}
selectedDates.add('{{ selected_date }}');
updatePreviewText();
{% endif %}

// Close calendar when clicking outside
document.addEventListener('click',function(e){
    if(calendarOpen && !calendarInteracting && !e.target.closest('.date-picker-container')){
        toggleCalendar(false);
    }
});

// Override renderFurnitureGrid to add contiguity check
const originalRenderFurnitureGrid=renderFurnitureGrid;
renderFurnitureGrid=function(){
    originalRenderFurnitureGrid();
    validateContiguity();
};

form.addEventListener('submit',async function(e){
    {% if mode == 'create' %}
    if(!customerId.value && !hotelGuestId.value){e.preventDefault();alert('Debe seleccionar un cliente');return}
    {% endif %}
    if(selectedFurniture.size===0){e.preventDefault();alert('Debe seleccionar al menos un mobiliario');return}

    // Handle multi-day reservations via API
    if(isMultiday() && selectedDates.size>1){
        e.preventDefault();
        const dates=getSelectedDates();
        if(dates.length<2){alert('Seleccione al menos 2 das para multi-da');return}

        const submitBtn=form.querySelector('button[type="submit"]');
        submitBtn.disabled=true;
        submitBtn.innerHTML='<i class="fas fa-spinner fa-spin me-2"></i>Creando reservas...';

        // Get customer ID (create from hotel guest if needed)
        let cid=customerId.value;
        if(!cid && hotelGuestId.value){
            // Create customer from hotel guest first
            try{
                const resp=await fetch('{{ url_for("beach.api.create_customer_from_guest") }}',{
                    method:'POST',
                    headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},
                    body:JSON.stringify({hotel_guest_id:parseInt(hotelGuestId.value)})
                });
                const data=await resp.json();
                if(data.success)cid=data.customer_id;
                else{alert(data.error||'Error creando cliente');submitBtn.disabled=false;submitBtn.innerHTML='Crear Reserva';return}
            }catch(err){alert('Error de conexin');submitBtn.disabled=false;submitBtn.innerHTML='Crear Reserva';return}
        }

        // Collect preferences
        const prefs=[];document.querySelectorAll('.reservation-pref:checked').forEach(cb=>prefs.push(cb.value));

        try{
            const resp=await fetch('{{ url_for("beach.api.create_multiday") }}',{
                method:'POST',
                headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},
                body:JSON.stringify({
                    customer_id:parseInt(cid),
                    dates:dates,
                    num_people:parseInt(document.getElementById('numPeople').value)||2,
                    furniture_ids:Array.from(selectedFurniture),
                    time_slot:'all_day',
                    payment_status:document.querySelector('select[name="payment_status"]').value,
                    charge_to_room:document.getElementById('chargeToRoom')?.checked?1:0,
                    charge_reference:document.getElementById('chargeReference')?.value||'',
                    preferences:prefs.join(','),
                    observations:document.querySelector('textarea[name="notes"]')?.value||''
                })
            });
            const data=await resp.json();
            if(data.success){
                alert(`Reserva multi-da creada: ${data.parent_ticket} (${data.total_created} das)`);
                window.location.href='{{ url_for("beach.reservations") }}';
            }else{
                alert(data.error||'Error al crear reserva');
                submitBtn.disabled=false;
                submitBtn.innerHTML='Crear Reserva';
            }
        }catch(err){
            console.error(err);
            alert('Error de conexin');
            submitBtn.disabled=false;
            submitBtn.innerHTML='Crear Reserva';
        }
        return;
    }

    // Normal single-day submission
    document.querySelectorAll('input[name="furniture_ids"]').forEach(el=>el.remove());
    selectedFurniture.forEach(id=>{const inp=document.createElement('input');inp.type='hidden';inp.name='furniture_ids';inp.value=id;form.appendChild(inp)});
});

{% if mode == 'edit' and reservation.furniture %}{% for f in reservation.furniture %}selectedFurniture.add({{ f.furniture_id }});{% endfor %}{% endif %}
if(reservationDate.value)loadFurnitureAvailability();

// Handle preselected customer from deep link (map "Ms opciones" button)
{% if preselected_customer %}
(function(){
    const customer = {
        id: {{ preselected_customer.id }},
        first_name: "{{ preselected_customer.first_name|e }}",
        last_name: "{{ preselected_customer.last_name|default('')|e }}",
        customer_type: "{{ preselected_customer.customer_type }}",
        room_number: "{{ preselected_customer.room_number|default('')|e }}",
        phone: "{{ preselected_customer.phone|default('')|e }}",
        email: "{{ preselected_customer.email|default('')|e }}",
        vip_status: {{ preselected_customer.vip_status|default(0) }},
        notes: "{{ preselected_customer.notes|default('')|e }}",
        source: 'customer',
        preferences: {{ preselected_customer.preference_codes|default([])|tojson }}
    };
    selectCustomer(customer);
    // Auto-select preferences that match
    if(customer.preferences && customer.preferences.length > 0) {
        customer.preferences.forEach(prefCode => {
            const cb = document.querySelector(`.preference-check[value="${prefCode}"]`);
            if(cb) cb.checked = true;
        });
    }
})();
{% endif %}

{% if preselected_hotel_guest %}
(function(){
    const guest = {
        id: {{ preselected_hotel_guest.id }},
        guest_name: "{{ preselected_hotel_guest.guest_name|e }}",
        room_number: "{{ preselected_hotel_guest.room_number|e }}",
        arrival_date: "{{ preselected_hotel_guest.arrival_date|default('')|e }}",
        departure_date: "{{ preselected_hotel_guest.departure_date|default('')|e }}",
        vip_code: "{{ preselected_hotel_guest.vip_code|default('')|e }}",
        nationality: "{{ preselected_hotel_guest.nationality|default('')|e }}",
        email: "{{ preselected_hotel_guest.email|default('')|e }}",
        phone: "{{ preselected_hotel_guest.phone|default('')|e }}",
        notes: "{{ preselected_hotel_guest.notes|default('')|e }}"
    };
    selectHotelGuest(guest, 1);
})();
{% endif %}

// Handle preselected multi-day dates from deep link
{% if selected_dates and selected_dates|length > 0 %}
(function(){
    const preselectedDates = {{ selected_dates|tojson }};
    preselectedDates.forEach(d => {
        if(d && d.trim()) selectedDates.add(d.trim());
    });
    updatePreviewText();
})();
{% endif %}

updateSummary();
});
</script>

<!-- Pricing Module -->
<script src="{{ url_for('static', filename='js/reservation_form_pricing.js') }}"></script>
{% endblock %}
