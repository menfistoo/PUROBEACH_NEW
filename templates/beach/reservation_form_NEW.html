{% extends "base.html" %}

{% set page_title = "Nueva Reserva" if mode == 'create' else "Editar Reserva" %}

{% block title %}{{ page_title }} - PuroBeach{% endblock %}

{% block content %}
<div class="mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('beach.reservations') }}">Reservas</a></li>
            <li class="breadcrumb-item active">{{ page_title }}</li>
        </ol>
    </nav>
</div>

<!-- Progress Steps -->
<div class="reservation-steps mb-4">
    <div class="step-container">
        <div class="step active" id="step1Indicator">
            <div class="step-number">1</div>
            <div class="step-label">Cliente</div>
        </div>
        <div class="step-line"></div>
        <div class="step" id="step2Indicator">
            <div class="step-number">2</div>
            <div class="step-label">Detalles</div>
        </div>
        <div class="step-line"></div>
        <div class="step" id="step3Indicator">
            <div class="step-number">3</div>
            <div class="step-label">Precio</div>
        </div>
        <div class="step-line"></div>
        <div class="step" id="step4Indicator">
            <div class="step-number">4</div>
            <div class="step-label">Confirmar</div>
        </div>
    </div>
</div>

<form method="POST" id="reservationForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="customer_id" id="customerId" value="">
    <input type="hidden" name="hotel_guest_id" id="hotelGuestId" value="">

    <div class="row">
        <!-- Left Column: Customer + Reservation Details + Pricing -->
        <div class="col-lg-8">
            {# STEP 1: CUSTOMER SELECTION #}
            {% include 'beach/reservation_form/_step1_customer.html' %}

            {# STEP 2: RESERVATION DETAILS (Date, Furniture, Preferences) #}
            {% include 'beach/reservation_form/_step2_details.html' %}

            {# STEP 3: PRICING (Package selection, Payment) #}
            {% include 'beach/reservation_form/_step3_pricing.html' %}
        </div>

        {# RIGHT COLUMN: SUMMARY #}
        {% include 'beach/reservation_form/_summary.html' %}
    </div>
</form>
{% endblock %}

{% block extra_css %}
<style>
.reservation-steps{background:var(--color-white);border-radius:var(--border-radius-lg);padding:20px 40px;box-shadow:var(--shadow-sm)}
.step-container{display:flex;align-items:center;justify-content:center}
.step{display:flex;flex-direction:column;align:center;gap:8px}
.step-number{width:40px;height:40px;border-radius:50%;background:var(--color-light-gray);color:var(--color-medium-gray);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;transition:all .3s}
.step.active .step-number,.step.completed .step-number{background:linear-gradient(135deg,var(--color-primary) 0%,var(--color-primary-dark) 100%);color:#fff;box-shadow:0 4px 12px rgba(212,175,55,.4)}
.step.completed .step-number{background:var(--color-success)}
.step-label{font-size:13px;font-weight:600;color:var(--color-medium-gray)}
.step.active .step-label,.step.completed .step-label{color:var(--color-secondary)}
.step-line{width:80px;height:3px;background:var(--color-light-gray);margin:0 15px;margin-bottom:28px;border-radius:2px}
.reservation-card{border:none;border-radius:var(--border-radius-lg);overflow:hidden;box-shadow:var(--shadow-md)}
.reservation-card .card-header{padding:20px 24px;border-bottom:none;display:flex;justify-content:space-between;align-items:center}
.card-header-primary{background:linear-gradient(135deg,var(--color-secondary) 0%,var(--color-secondary-light,#2A5A8C) 100%);color:var(--color-surface)}
.card-header-gold{background:linear-gradient(135deg,var(--color-primary) 0%,var(--color-primary-dark) 100%);color:#fff}
.card-header-gold h5{color:#fff}
.step-icon{width:44px;height:44px;background:rgba(255,255,255,.2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px}
.reservation-card .card-body{padding:24px}
.search-input-wrapper{position:relative}
.search-icon{position:absolute;left:16px;top:50%;transform:translateY(-50%);color:var(--color-medium-gray);font-size:18px;z-index:2}
.search-input-wrapper .form-control{padding-left:48px;padding-right:48px;border-radius:var(--border-radius-lg);border:2px solid var(--color-border);transition:border-color .2s,box-shadow .2s}
.search-input-wrapper .form-control:focus{border-color:var(--color-primary);box-shadow:0 0 0 4px rgba(212,175,55,.15)}
.search-loading{position:absolute;right:16px;top:50%;transform:translateY(-50%);color:var(--color-primary)}
.search-results-container{margin-top:12px;background:var(--color-surface);border:1px solid var(--color-border);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-lg);max-height:400px;overflow-y:auto}
.results-section{border-bottom:1px solid var(--color-border)}
.results-section:last-of-type{border-bottom:none}
.results-header{padding:12px 16px;background:var(--color-off-white);font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--color-text-muted);display:flex;align-items:center;gap:8px}
.result-item{padding:14px 16px;border-bottom:1px solid var(--color-border);cursor:pointer;transition:background .2s;display:flex;align-items:center;gap:12px}
.result-item:last-child{border-bottom:none}
.result-item:hover{background:var(--color-accent)}
.result-avatar{width:40px;height:40px;border-radius:50%;background:var(--color-light-gray);display:flex;align-items:center;justify-content:center;color:var(--color-medium-gray);flex-shrink:0}
.result-avatar.hotel{background:var(--color-info-light,#e3f2fd);color:var(--color-info,#1976d2)}
.result-avatar.vip{background:var(--color-warning-light,#fff8e1);color:var(--color-warning)}
.result-info{flex:1;min-width:0}
.result-name{font-weight:600;color:var(--color-text);display:flex;align-items:center;gap:8px}
.result-details{font-size:13px;color:var(--color-text-muted);margin-top:2px}
.result-action{color:var(--color-primary);font-size:14px}
.no-results-section{padding:20px;text-align:center}
.no-results-message{color:var(--color-text-muted);display:flex;align-items:center;justify-content:center;gap:8px}
.create-customer-option{padding:16px;border-top:1px solid var(--color-border)}
.divider-line{text-align:center;position:relative;margin-bottom:12px}
.divider-line::before{content:'';position:absolute;left:0;top:50%;width:100%;height:1px;background:var(--color-border)}
.divider-line span{background:var(--color-surface);padding:0 12px;position:relative;color:var(--color-text-muted);font-size:12px}
.create-customer-form{background:linear-gradient(135deg,var(--color-background) 0%,var(--color-surface) 100%);border:2px solid var(--color-primary);border-radius:var(--border-radius-lg);padding:20px;margin-top:16px}
.create-customer-form .form-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--color-border)}
.create-customer-form .form-header h6{margin:0;color:var(--color-secondary)}
.form-actions{display:flex;justify-content:flex-end;gap:12px}
.phone-input-group{display:flex;gap:8px}
.phone-input-group .country-select{flex:0 0 100px}
.phone-input-group .form-control{flex:1}
.phone-input-small .country-select{flex:0 0 90px}
.selected-customer-card{background:linear-gradient(135deg,var(--color-surface) 0%,var(--color-accent) 100%);border:2px solid var(--color-primary);border-radius:var(--border-radius-lg);padding:20px}
.customer-header{display:flex;align-items:flex-start;gap:16px;margin-bottom:12px}
.customer-avatar{width:60px;height:60px;border-radius:50%;background:var(--color-light-gray);display:flex;align-items:center;justify-content:center;color:var(--color-medium-gray);font-size:24px;flex-shrink:0}
.customer-avatar.hotel{background:var(--color-info-light,#e3f2fd);color:var(--color-info,#1976d2)}
.customer-main-info{flex:1;min-width:0}
.customer-actions{display:flex;gap:8px;flex-shrink:0}
.customer-subtitle{font-size:14px;color:var(--color-text-muted)}
.hotel-info-section,.customer-stats-section{margin-top:12px}
.info-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:var(--color-surface);border-radius:var(--border-radius);font-size:13px;color:var(--color-text-muted)}
.info-badge i{color:var(--color-primary)}
.guest-selector-section{margin-top:12px;padding:12px;background:var(--color-surface);border-radius:var(--border-radius)}
.customer-additional-fields{padding-top:12px;border-top:1px solid var(--color-border)}
.customer-prefs-notes{padding-top:12px;border-top:1px solid var(--color-border)}
.notes-display,.prefs-display{padding:8px 12px;background:var(--color-surface);border-radius:var(--border-radius);margin-bottom:8px;font-size:13px}
.notes-display{color:var(--color-warning-dark,#f57c00);border-left:3px solid var(--color-warning)}
.prefs-display{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.prefs-label{font-weight:600;color:var(--color-text-muted)}
.history-section{padding-top:12px;border-top:1px solid var(--color-border)}
.history-header{display:flex;justify-content:space-between;align-items:center;font-size:14px;margin-bottom:8px}
.history-list{max-height:200px;overflow-y:auto}
.history-item{padding:10px;background:var(--color-surface);border-radius:var(--border-radius);margin-bottom:8px;font-size:13px}
.empty-state{text-align:center;padding:40px 20px;color:var(--color-text-muted)}
.empty-icon{font-size:48px;margin-bottom:16px;color:var(--color-medium-gray)}
.booking-basics{background:var(--color-background);padding:20px;border-radius:var(--border-radius-lg)}
.date-picker-container{position:relative}
.date-picker-collapsed{padding:14px 16px;background:var(--color-surface);border:2px solid var(--color-border);border-radius:var(--border-radius);cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:border-color .2s,box-shadow .2s}
.date-picker-collapsed:hover{border-color:var(--color-primary)}
.date-picker-collapsed.active{border-color:var(--color-primary);box-shadow:0 0 0 4px rgba(212,175,55,.15)}
.selected-dates-preview{display:flex;align-items:center;flex:1}
.calendar-expanded{margin-top:8px;padding:16px;background:var(--color-surface);border:2px solid var(--color-primary);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-lg)}
.multi-calendar{margin-bottom:12px}
.calendar-footer{padding-top:12px;border-top:1px solid var(--color-border)}
.selected-dates-tags{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
.date-tag{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:var(--color-primary);color:#fff;border-radius:var(--border-radius);font-size:13px;font-weight:600}
.date-tag button{background:none;border:none;color:#fff;cursor:pointer;padding:0;width:16px;height:16px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background .2s}
.date-tag button:hover{background:rgba(255,255,255,.2)}
.furniture-selection{background:var(--color-background);padding:20px;border-radius:var(--border-radius-lg)}
.furniture-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;flex-wrap:wrap;gap:12px}
.furniture-filters{display:flex;gap:8px;flex-wrap:wrap}
.furniture-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:12px;margin-bottom:16px}
.furniture-placeholder{grid-column:1/-1;text-align:center;padding:40px 20px}
.furniture-item{background:var(--color-surface);border:2px solid var(--color-border);border-radius:var(--border-radius);padding:12px;text-align:center;cursor:pointer;transition:all .2s}
.furniture-item:hover:not(.occupied){border-color:var(--color-primary);transform:translateY(-2px);box-shadow:var(--shadow-sm)}
.furniture-item.available{border-color:var(--color-success-light,#c8e6c9)}
.furniture-item.occupied{background:var(--color-light-gray);color:var(--color-text-muted);cursor:not-allowed;opacity:.6}
.furniture-item.selected{background:linear-gradient(135deg,var(--color-primary) 0%,var(--color-primary-dark) 100%);border-color:var(--color-primary);color:#fff;box-shadow:0 4px 12px rgba(212,175,55,.4)}
.furniture-item .furniture-icon{font-size:24px;margin-bottom:8px}
.furniture-item .furniture-name{font-weight:600;font-size:14px}
.furniture-item .furniture-zone{font-size:11px;opacity:.8;margin-top:4px}
.furniture-summary{display:flex;justify-content:space-between;align-items:center;padding-top:12px;border-top:1px solid var(--color-border)}
.summary-item{font-weight:600}
.summary-legend{display:flex;gap:16px;font-size:13px}
.legend-item{display:flex;align-items:center;gap:6px}
.legend-item .dot{width:12px;height:12px;border-radius:50%;border:2px solid currentColor}
.legend-item .dot.available{background:var(--color-success);border-color:var(--color-success)}
.legend-item .dot.selected{background:var(--color-primary);border-color:var(--color-primary)}
.legend-item .dot.occupied{background:var(--color-light-gray);border-color:var(--color-medium-gray)}
.payment-section,.preferences-section,.notes-section{background:var(--color-background);padding:20px;border-radius:var(--border-radius-lg)}
.section-title{font-size:15px;font-weight:600;margin-bottom:16px}
.preferences-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px}
.preferences-inline{display:flex;flex-wrap:wrap;gap:8px}
.preference-chip,.preference-chip-inline{position:relative}
.preference-chip input,.preference-chip-inline input{position:absolute;opacity:0;pointer-events:none}
.preference-chip .chip-content,.preference-chip-inline .chip-content{display:flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px;background:var(--color-surface);border:2px solid var(--color-border);border-radius:var(--border-radius);cursor:pointer;transition:all .2s;font-size:14px}
.preference-chip-inline .chip-content{padding:6px 12px;font-size:13px}
.preference-chip input:checked + .chip-content,.preference-chip-inline input:checked + .chip-content{background:var(--color-primary);border-color:var(--color-primary);color:#fff}
.preference-chip .chip-content:hover,.preference-chip-inline .chip-content:hover{border-color:var(--color-primary);transform:translateY(-2px)}
.reservation-summary-card{border:none;border-radius:var(--border-radius-lg);box-shadow:var(--shadow-md)}
.reservation-summary-card .card-header{background:linear-gradient(135deg,var(--color-secondary) 0%,var(--color-secondary-light,#2A5A8C) 100%);color:#fff;padding:16px 20px}
.summary-section{padding:16px 0}
.summary-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--color-border)}
.summary-row:last-child{border-bottom:none}
.summary-label{font-weight:600;color:var(--color-text-muted);font-size:14px}
.summary-value{font-weight:700;color:var(--color-text);font-size:14px}
.furniture-list{font-size:13px}
.furniture-list-item{padding:6px 0;display:flex;align-items:center;gap:8px}
.action-buttons .btn{border-radius:var(--border-radius)}
.furniture-alerts{display:none}
.furniture-alerts.show{display:block}
.alert{padding:12px;border-radius:var(--border-radius);margin-bottom:8px}
</style>

<!-- Load main form JavaScript from original file inline for now -->
<!-- TODO: Extract to separate file later -->
{% include 'beach/reservation_form/_scripts.html' %}
{% endblock %}
