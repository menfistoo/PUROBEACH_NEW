# Issues - 27 December 2025

## âœ… FIXED

### 1. Hotel Guest Reservations Show â‚¬0.00 Price
**Date:** 2025-12-27
**Priority:** High
**Status:** âœ… FIXED

**Description:**
When creating a reservation for a hotel guest who is not yet a beach club customer, the pricing displays as â‚¬0.00 even though pricing packages are configured and should apply.

**Root Cause:**
The pricing service was attempting to look up the hotel guest ID in the `beach_customers` table instead of the `hotel_guests` table. When the lookup failed, it returned an error and the frontend displayed â‚¬0.00.

**Solution:**
- Added `customer_source` parameter to the pricing API (`/beach/api/pricing/calculate`)
- Modified pricing service to handle both customer sources:
  - `customer_source = "hotel_guest"` â†’ looks up in `hotel_guests` table
  - `customer_source = "customer"` â†’ looks up in `beach_customers` table
- Updated frontend to send the correct `customer_source` based on selection
- Added pricing calculation trigger in `handleHotelGuestSelect()` method

**Files Modified:**
- `blueprints/beach/routes/api/pricing.py`
- `blueprints/beach/services/pricing_service.py`
- `static/js/map/reservation-panel/pricing-calculator.js`
- `static/js/map/reservation-panel/customer-handler.js`

**Testing:**
- âœ… Hotel guest reservations now show correct pricing
- âœ… Internal pricing packages apply to hotel guests
- âœ… Existing customer reservations continue to work

---

### 2. Package "Teste - externo" Not Appearing in Package Selector
**Date:** 2025-12-27
**Priority:** Medium
**Status:** âœ… FIXED

**Description:**
The package configured for external customers ("Teste - externo") does not appear in the package selector dropdown when creating reservations, even when all conditions are met (customer type = externo, people count within range, etc.).

**Root Cause:**
The `furniture_types_included` field in the database contained the string `'None'` instead of `NULL`. The pricing filter logic treated this as a furniture type restriction (looking for furniture of type "none"), causing the package to be filtered out for all reservations.

**Solution:**
1. **Database Fix:** Updated the package record to set `furniture_types_included = NULL` instead of `'None'`
2. **Code Improvement:** Enhanced the filtering logic in `pricing_service.py` to handle both `NULL` and the string `'None'` as "no restriction"
3. **Template Fix:** Corrected `package_form.html` to use Jinja2's `default()` filter to prevent displaying `'None'` when the value is NULL

**Technical Details:**
```python
# Before (buggy):
if package["furniture_types_included"]:
    # This evaluated to True for 'None' string

# After (fixed):
furniture_types_str = package["furniture_types_included"]
if furniture_types_str and str(furniture_types_str).lower() != 'none':
    # Now properly handles both NULL and 'None' string
```

**Files Modified:**
- Database: `beach_packages` table (ID 4)
- `blueprints/beach/services/pricing_service.py`
- `templates/beach/config/package_form.html`

**Testing:**
- âœ… "Teste - externo" package now appears for external customers
- âœ… Package appears regardless of furniture type selected
- âœ… Other packages continue to filter correctly by furniture type
- âœ… Future package edits will not create the 'None' string issue

---

### 3. Guest Number Field Resets Immediately After Change
**Date:** 2025-12-27
**Priority:** High
**Status:** âœ… FIXED

**Description:**
When creating or editing a reservation, the "Number of Guests" field resets immediately after the user tries to change it. This affects both:
- **New Reservation Panel:** Quick reservations from the map
- **Details/Edit Panel:** Editing existing reservations

**Root Causes:**

**Issue A - New Reservation Panel:**
Auto-fill logic from hotel guest lookup and customer selection was continuously overwriting the field, even after manual user edits.

**Issue B - Details/Edit Panel:**
The map's auto-refresh (every 30 seconds) would call `renderDetailsSection()`, which unconditionally overwrote the input field, resetting any user edits in progress.

**Solution:**
Implemented a **manual edit tracking system** in both panels:

1. Added `numPeopleManuallyEdited` flag to track user edits
2. Mark flag as `true` when user types in the field
3. All auto-fill logic checks the flag before updating the field
4. Reset flag when opening new reservation or saving/canceling edits

**Code Changes:**
```javascript
// Track manual edits
this.numPeopleManuallyEdited = false;

// Mark as edited when user types
this.numPeopleInput.addEventListener('input', () => {
    this.numPeopleManuallyEdited = true;
});

// Only auto-fill if not manually edited
if (numPeopleInput && !this.numPeopleManuallyEdited) {
    numPeopleInput.value = guestCount;
}
```

**Files Modified:**
- `static/js/map/reservation-panel/panel-core.js` (new reservation)
- `static/js/map/reservation-panel/customer-handler.js` (auto-fill logic)
- `static/js/map/reservation-panel.js` (details/edit panel)

**Testing:**
- âœ… Can manually edit guest count in new reservations
- âœ… Can manually edit guest count in existing reservations
- âœ… Value persists during map auto-refresh
- âœ… Auto-fill still works when selecting hotel guests (before manual edit)
- âœ… Flag resets correctly when opening new reservation or saving

---

### 4. Guest Number Automatically Capped at Furniture Capacity
**Date:** 2025-12-27
**Priority:** Medium
**Status:** âœ… FIXED

**Description:**
When creating a new reservation, users could not enter a guest count higher than the selected furniture's total capacity. For example, with 2 hamacas (capacity = 4), trying to enter "3" or higher would immediately reset to "2" or be capped at "4".

**Root Cause:**
The `change` event handler in `panel-core.js` had validation logic that automatically reset the guest number to the furniture capacity whenever the user tried to exceed it.

**Previous Behavior:**
```javascript
// Automatically prevented overbooking
if (parseInt(this.numPeopleInput.value) > capacity) {
    this.numPeopleInput.value = capacity;  // Hard reset!
}
```

**Solution:**
Removed the automatic capping and replaced it with a **warning-based approach**:
- Users can now enter any guest count (1-20)
- System shows a capacity warning if guests exceed furniture capacity
- Warning suggests adding more furniture
- Users can proceed with overbooking or add furniture as needed

**New Behavior:**
```javascript
// Show warning but allow overbooking
if (numPeople > capacity) {
    this.showCapacityWarning(numPeople, capacity);
} else {
    this.hideCapacityWarning();
}
```

**Files Modified:**
- `static/js/map/reservation-panel/panel-core.js`

**Testing:**
- âœ… Can enter guest counts above furniture capacity
- âœ… Warning appears when capacity is exceeded
- âœ… Warning clears when guest count is within capacity
- âœ… Can add more furniture via the warning button
- âœ… Can proceed with reservation despite warning

---

## Summary

**Total Issues:** 4
**Fixed:** 4 âœ…
**Pending:** 0 ðŸ”´

**Session Highlights:**
This session focused on resolving critical UX issues in the reservation workflow:
1. **Pricing bugs** prevented accurate cost display for hotel guests and certain package configurations
2. **Input field resets** made it impossible for users to manually adjust guest counts
3. **Overly restrictive validation** prevented valid use cases (overbooking scenarios)

All issues were resolved by improving the balance between helpful automation and user control. The system now:
- Auto-fills intelligently but respects manual user input
- Warns users about potential issues without blocking valid actions
- Handles edge cases (hotel guests, external packages, capacity overages) gracefully

**Architecture Improvements:**
- Introduced manual edit tracking pattern for input fields
- Added customer source awareness to pricing system
- Improved warning systems to inform rather than restrict
- Enhanced null/None handling in database queries
